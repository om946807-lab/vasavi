<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance Bills -Sri Vasavi Jewellers</title>
    <link rel="stylesheet" href="all-bills.css">
    <link rel="icon" href="logo.png" type="image/x-icon">

</head>

<body>
    <header class="header">
        <button class="back-button" onclick="window.history.back()">Back</button>
        <h1>Balance Bills</h1>
    </header>
    <div class="container">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search bills..." oninput="searchBills()">
            <button id="searchButton" onclick="searchBills()">Search</button>
        </div>

        <table class="bills-table">
            <thead>
                <tr>
                    <th>Bill Number</th>
                    <th>Customer Name</th>
                    <th>Phone</th>
                    <th>Bill Date</th>
                    <th>Subtotal</th>
                    <th>Discount</th>
                    <th>Amount Paid</th>
                    <th>Old Gold</th>
                    <th>Old balance</th>
                    <th>Balance</th>
                    <th>Items</th>
                    <th>Actions</th>
                    <th>History</th>
                    <th>Print bill</th>

                </tr>
            </thead>
            <tbody id="bill-data">
                <!-- Dynamic content will be inserted here -->
            </tbody>

        </table>
        <div id="itemsModal" class="modal" style="display:none;">
            <div class="modal-content">
                <span class="close-items">&times;</span>
                <h2>Items</h2>
                <table id="itemsTable" class="history-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Item Name</th>
                            <th>Quantity</th>
                            <th>Amount per Gram</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        <div id="totalBalance" class="totalBalance">Total Balance:</div>

    </div>

    <!-- Modal for Payment History -->
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Payment History</h2>
            <table id="historyTable" class="history-table">
                <thead>
                    <tr>
                        <th>Sub-Bill Number</th>
                        <th>Amount Paid</th>
                        <th>Payment Date</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- History rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        async function showItems(billNumber) {
            const modal = document.getElementById('itemsModal');
            const closeModal = document.querySelector('.close-items');
            const itemsTableBody = document.querySelector('#itemsTable tbody');

            try {
                // Fetch the bill items from the server
                const response = await fetch(`/bill-items/${billNumber}`);

                // Check if the response is OK
                if (!response.ok) {
                    // If the response is not OK, throw an error
                    throw new Error('Network response was not ok');
                }

                // Parse the response data
                const data = await response.json();

                // Clear the current table content
                itemsTableBody.innerHTML = '';

                // Ensure that the `items` field in the response is an array
                if (Array.isArray(data.items) && data.items.length > 0) {
                    // Iterate over each item and append rows to the table
                    let rows = '';
                    data.items.forEach(item => {
                        rows += `
                            <tr>
                                <td><strong>${item.sub_item_id}</strong></td>
                                <td><strong>${item.item_name}</strong></td>
                                <td><strong>${item.quantity}gm</strong></td>
                                <td><strong>${item.amount_per_gram}</strong></td>
                            </tr>
                        `;
                    });

                    // Insert the rows into the table body
                    itemsTableBody.innerHTML = rows;
                } else {
                    // Handle the case where there are no items
                    itemsTableBody.innerHTML = '<tr><td colspan="3">No items found for this bill</td></tr>';
                }

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                // Log any error encountered during the fetch process
                console.error('Error fetching bill items:', error);
            }

            // Close the modal when the user clicks on the close button (x)
            closeModal.onclick = function () {
                modal.style.display = 'none';
            };

            // Close the modal when the user clicks outside the modal content
            window.onclick = function (event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }


        function viewBill(billNumber) {
            window.open(`/generate-bill/purchase-print-bill.html?billNumber=${(billNumber)}`, '_blank');
        }

        // Function to format numbers in the Indian numbering system
        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(num);
        }

        // Fetching bills from the server and populating the table
        async function fetchBills() {
            try {
                const response = await fetch('/bills');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                const tableBody = document.getElementById('bill-data');
                const totalBalanceElement = document.getElementById('totalBalance');
                let totalBalance = 0;

                if (data.bills && Array.isArray(data.bills)) {
                    let rows = '';

                    // Filter bills with balance greater than 0
                    data.bills.forEach(bill => {
                        if (bill.balance_amount > 0) {
                            rows += `
                                <tr>
                                    <td>${bill.bill_number}</td>
                                    <td>${bill.customer_name}</td>
                                    <td>${bill.customer_phone}</td>
                                    <td>${new Date(bill.bill_date).toLocaleDateString('en-GB')}</td>
                                    <td>₹${formatNumber(bill.subtotal.toFixed(2))}</td>
                                    <td>₹${formatNumber(bill.discount.toFixed(2))}</td>
                                    <td>₹${formatNumber(bill.amount_paid.toFixed(2))}</td>
                                    <td>₹${formatNumber(bill.oldGold.toFixed(2))}</td>
                                    <td>₹${formatNumber(bill.old_balance.toFixed(2))}</td>
                                    <td>₹${formatNumber(bill.balance_amount.toFixed(2))}</td>
                                    <td><button onclick="showItems('${bill.bill_number}')">View Items</button></td> <!-- View Items button -->

                                    <td>
                                        <button onclick="payBalance('${bill.bill_number}', '${bill.balance_amount}', '${bill.customer_name}')">Pay Balance</button>
                                    </td>
                                    <td>
                                        <button onclick="showHistory('${bill.bill_number}')">View History</button>
                                    </td>
                                    <td>
                                        <button onclick="viewBill('${bill.bill_number}')">Bill</button>
                                    </td>

                                </tr>
                            `;
                        }
                        totalBalance += parseInt(bill.balance_amount);

                    });

                    tableBody.innerHTML = rows;
                } else {
                    console.error('Invalid data format:', data);
                }
                totalBalanceElement.textContent = `Balance:₹${formatNumber(totalBalance)} `;
            } catch (error) {
                console.error('Error fetching bills:', error);
            }
        }
        // Function to search through the table
        function searchBills() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const table = document.querySelector('.bills-table');
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const cells = row.getElementsByTagName('td');
                let match = false;

                for (let i = 0; i < cells.length; i++) {
                    if (cells[i].innerText.toLowerCase().includes(input)) {
                        match = true;
                        break;
                    }
                }

                row.style.display = match ? '' : 'none';
            });
        }
        async function payBalance(billNumber, currentBalance, customerName) {
            return new Promise((resolve) => {
                // Overlay for payment input
                const modalOverlay = document.createElement('div');
                modalOverlay.innerHTML = `
            <div style="
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.15);
                backdrop-filter: blur(6px);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10001;
                font-family: 'Poppins', sans-serif;
                animation: fadeIn 0.3s ease;
            ">
                <div style="
                    background: linear-gradient(145deg, #ffffff, #f0f2f5);
                    padding: 50px 50px;
                    border-radius: 30px;
                    width: 520px;
                    max-width: 95%;
                    text-align: center;
                    box-shadow: 0 30px 60px rgba(0,0,0,0.25), 0 15px 35px rgba(0,0,0,0.15);
                    animation: slideUp 0.5s ease;
                ">
                    <h2 style="font-size:30px; font-weight:900; color:#1e293b; margin-bottom:25px;">Pay Balance</h2>
                    <p style="font-size:20px; color:#334155; font-weight:600; margin-bottom:15px;">
                        Customer: <strong>${customerName}</strong>
                    </p>
                    <p style="font-size:20px; color:#334155; font-weight:600; margin-bottom:15px;">
                        Bill Number: <strong>${billNumber}</strong>
                    </p>
                    <p style="font-size:20px; color:#334155; font-weight:700; margin-bottom:25px;">
                        Current Balance: 
                        <span style="
                            background: linear-gradient(45deg, #6366f1, #4338ca);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                            font-weight: 900;
                            font-size:24px;
                        ">
                            ₹${currentBalance}
                        </span>
                    </p>
                    <input type="number" id="amountInput" placeholder="Enter amount to pay"
                        max="${currentBalance}" step="0.01" style="
                        width: 100%;
                        padding: 20px;
                        border: 2px solid #e2e8f0;
                        border-radius: 16px;
                        font-size: 18px;
                        margin: 25px 0 35px;
                        outline: none;
                        transition: all 0.3s ease;
                        box-shadow: inset 0 2px 10px rgba(0,0,0,0.08);
                    ">
                    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                        <button id="confirmBtn" class="premium-btn confirm">Confirm Payment</button>
                        <button id="fullBtn" class="premium-btn full">Pay Full Balance</button>
                        <button id="cancelBtn" class="premium-btn cancel">Cancel</button>
                    </div>
                </div>
            </div>
            <style>
                @keyframes fadeIn { from{opacity:0} to{opacity:1} }
                @keyframes slideUp { from{transform:translateY(50px); opacity:0} to{transform:translateY(0); opacity:1} }
                @keyframes pulse { 0%{transform:scale(1);} 50%{transform:scale(1.05);} 100%{transform:scale(1);} }

                .premium-btn {
                    padding: 16px 40px;
                    border: none;
                    border-radius: 18px;
                    font-size: 18px;
                    font-weight: 700;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                    overflow: hidden;
                }
                .premium-btn.confirm {
                    background: linear-gradient(145deg, #6366f1, #4338ca);
                    color: #fff;
                    box-shadow: 0 8px 20px rgba(99,102,241,0.35);
                }
                .premium-btn.full {
                    background: linear-gradient(145deg, #10b981, #059669);
                    color: #fff;
                    box-shadow: 0 8px 20px rgba(16,185,129,0.35);
                }
                .premium-btn.cancel {
                    background: linear-gradient(145deg, #f8fafc, #e2e8f0);
                    color: #334155;
                    box-shadow: 0 8px 20px rgba(0,0,0,0.12);
                }
                .premium-btn:hover { transform: translateY(-3px); animation: pulse 1.2s infinite; }
            </style>
        `;

                const overlay = modalOverlay.firstElementChild;
                document.body.appendChild(modalOverlay);

                async function showConfirmation(amount) {
                    return new Promise((resolve) => {
                        const confirmOverlay = document.createElement('div');
                        confirmOverlay.innerHTML = `
                    <div style="
                        position: fixed; top:0; left:0; right:0; bottom:0;
                        background: rgba(0,0,0,0.15);
                        backdrop-filter: blur(6px);
                        display:flex; justify-content:center; align-items:center;
                        z-index:10010; font-family:'Poppins',sans-serif;
                    ">
                        <div style="
                            background:#ffffff; padding:45px 35px; border-radius:28px;
                            width:480px; max-width:90%; text-align:center;
                            box-shadow:0 25px 60px rgba(0,0,0,0.25),0 10px 30px rgba(0,0,0,0.15);
                        ">
                            <h2 style="font-size:28px; font-weight:800; color:#1e293b; margin-bottom:25px;">Confirm Payment</h2>
                            <p style="font-size:18px; color:#334155; margin-bottom:35px; line-height:1.5;">
                                Are you sure you want to pay <strong>₹${amount}</strong>?
                            </p>
                            <div style="display:flex; justify-content:center; gap:20px; flex-wrap:wrap;">
                                <button id="yesBtn" style="
                                    background: linear-gradient(145deg,#6366f1,#4338ca);
                                    color:#fff; padding:16px 36px; border:none; border-radius:16px;
                                    font-size:18px; font-weight:700; cursor:pointer; box-shadow:0 8px 20px rgba(99,102,241,0.35);
                                ">Yes, Pay</button>
                                <button id="noBtn" style="
                                    background: linear-gradient(145deg,#f8fafc,#e2e8f0);
                                    color:#334155; padding:16px 36px; border:none; border-radius:16px;
                                    font-size:18px; font-weight:700; cursor:pointer; box-shadow:0 8px 20px rgba(0,0,0,0.12);
                                ">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
                        const overlay = confirmOverlay.firstElementChild;
                        document.body.appendChild(confirmOverlay);

                        overlay.querySelector("#yesBtn").addEventListener("click", () => {
                            confirmOverlay.remove();
                            resolve(true);
                        });
                        overlay.querySelector("#noBtn").addEventListener("click", () => {
                            confirmOverlay.remove();
                            resolve(false);
                        });
                    });
                }

                async function handlePayment(amount) {
                    const userConfirmed = await showConfirmation(amount);
                    if (!userConfirmed) return;

                    try {
                        const response = await fetch(`/pay-bill/${billNumber}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ amount_paid: amount })
                        });
                        const resBody = await response.json();

                        if (response.ok && resBody.message === 'Payment successful') {
                            showPaymentSuccess(amount, customerName);
                            modalOverlay.remove();
                        } else {
                            alert(resBody.error || 'Payment failed');
                        }
                    } catch (err) {
                        alert(err.message || 'Payment failed');
                    }
                }

                overlay.querySelector('#confirmBtn').addEventListener('click', () => {
                    const amount = parseFloat(overlay.querySelector('#amountInput').value);
                    if (!isNaN(amount) && amount > 0 && amount <= currentBalance) {
                        handlePayment(amount);
                    } else {
                        const input = overlay.querySelector('#amountInput');
                        input.style.borderColor = '#ef4444';
                        input.style.animation = 'pulse 0.3s ease';
                        setTimeout(() => { input.style.borderColor = '#e2e8f0'; input.style.animation = ''; }, 1500);
                    }
                });

                overlay.querySelector('#fullBtn').addEventListener('click', () => handlePayment(currentBalance));
                overlay.querySelector('#cancelBtn').addEventListener('click', () => { modalOverlay.remove(); resolve(); });

                // Payment Success Box
                function showPaymentSuccess(amount, customerName) {
                    const successOverlay = document.createElement('div');
                    successOverlay.style.cssText = `
                position: fixed; top:0; left:0; right:0; bottom:0;
                display:flex; justify-content:center; align-items:center;
                background: rgba(0,0,0,0.1);
                backdrop-filter: blur(10px);
                z-index:10020;
                font-family:'Poppins',sans-serif;
            `;
                    const card = document.createElement('div');
                    card.style.cssText = `
                background:#ffffff; padding:70px 60px; border-radius:35px;
                width:550px; max-width:95%; text-align:center;
                box-shadow:0 30px 70px rgba(0,0,0,0.25),0 15px 40px rgba(0,0,0,0.15);
                animation: slideUp 0.5s ease;
            `;
                    card.innerHTML = `
                <div style="font-size:110px; color:#10b981; margin-bottom:25px;">✅</div>
                <h2 style="font-size:36px; font-weight:900; color:#10b981; margin-bottom:25px;">Payment Successful</h2>
                <p style="font-size:22px; color:#334155; margin-bottom:50px; line-height:1.6;">
                    ₹${amount} has been paid for <strong>${customerName}</strong> successfully!
                </p>
                <button id="doneBtn" style="
                    background: linear-gradient(145deg,#6366f1,#4338ca);
                    color:#fff; font-size:20px; font-weight:700;
                    padding:18px 40px; border:none; border-radius:18px; cursor:pointer;
                    box-shadow:0 8px 25px rgba(99,102,241,0.35); transition: all 0.3s ease;
                ">Done</button>
            `;
                    successOverlay.appendChild(card);
                    document.body.appendChild(successOverlay);

                    const doneBtn = card.querySelector('#doneBtn');
                    doneBtn.addEventListener('mouseenter', () => doneBtn.style.transform = 'translateY(-3px)');
                    doneBtn.addEventListener('mouseleave', () => doneBtn.style.transform = 'translateY(0)');
                    doneBtn.addEventListener('click', () => {
                        if (successOverlay.parentNode) successOverlay.parentNode.removeChild(successOverlay);
                        location.reload();
                    });

                    setTimeout(() => {
                        if (successOverlay.parentNode) successOverlay.parentNode.removeChild(successOverlay);
                        location.reload();
                    }, 3000);
                }
            });
        }


        async function showHistory(billNumber) {
            // Remove existing modal if any
            let existingModal = document.getElementById('historyModal');
            if (existingModal) existingModal.remove();

            const modal = document.createElement('div');
            modal.id = 'historyModal';
            modal.style.cssText = `
        position: fixed; top:0; left:0; right:0; bottom:0;
        background: rgba(0,0,0,0.35);
        backdrop-filter: blur(6px);
        display: flex; justify-content:center; align-items:center;
        z-index:10010; font-family:'Poppins', sans-serif;
    `;

            const container = document.createElement('div');
            container.style.cssText = `
        background: #fff;
        border-radius: 28px;
        width: 650px;
        max-width: 95%;
        max-height: 80vh;
        overflow-y: auto;
        padding: 30px 25px;
        box-shadow: 0 25px 60px rgba(0,0,0,0.25),0 10px 30px rgba(0,0,0,0.15);
        position: relative;
        animation: fadeIn 0.4s ease, slideUp 0.4s ease;
    `;

            // Close button
            const closeBtn = document.createElement('span');
            closeBtn.innerHTML = '&times;';
            closeBtn.style.cssText = `
        position: absolute; top:16px; right:20px;
        font-size:28px; font-weight:bold; cursor:pointer; color:#334155;
    `;
            closeBtn.onclick = () => modal.remove();
            container.appendChild(closeBtn);

            // Title
            const title = document.createElement('h2');
            title.textContent = 'Payment History';
            title.style.cssText = `
        font-size:28px; font-weight:800; color:#1e293b; margin-bottom:20px; text-align:center;
    `;
            container.appendChild(title);

            // Payment cards wrapper
            const cardsWrapper = document.createElement('div');
            cardsWrapper.style.cssText = 'display:flex; flex-direction:column; gap:18px;';
            container.appendChild(cardsWrapper);

            modal.appendChild(container);
            document.body.appendChild(modal);

            try {
                const response = await fetch(`/payment-history/${billNumber}`);
                if (!response.ok) throw new Error('Network response was not ok');
                const data = await response.json();

                let totalAmountPaid = 0;

                if (data.subBills && Array.isArray(data.subBills) && data.subBills.length > 0) {
                    data.subBills.forEach(subBill => {
                        const amountPaid = parseFloat(subBill.amount_paid || 0);
                        totalAmountPaid += amountPaid;
                        const paymentDate = subBill.payment_date ?
                            new Date(subBill.payment_date).toLocaleDateString('en-GB') : 'N/A';
                        const paymentTime = subBill.payment_date ?
                            new Date(subBill.payment_date).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' }) : 'N/A';

                        const card = document.createElement('div');
                        card.style.cssText = `
                    background: linear-gradient(145deg,#f8fafc,#e2e8f0);
                    padding:20px 25px; border-radius:18px;
                    box-shadow:0 6px 20px rgba(0,0,0,0.12);
                    display:flex; justify-content:space-between; align-items:center;
                    transition: transform 0.2s ease, box-shadow 0.2s ease;
                    position:relative;
                `;
                        card.onmouseenter = () => card.style.transform = 'translateY(-4px)';
                        card.onmouseleave = () => card.style.transform = 'translateY(0)';

                        card.innerHTML = `
                    <div style="display:flex; flex-direction:column; gap:6px;">
                        <div style="
                            font-weight:800; font-size:20px;
                            background: linear-gradient(90deg,#6366f1,#4338ca);
                            -webkit-background-clip: text;
                            -webkit-text-fill-color: transparent;
                        ">Bill: ${subBill.sub_bill_number || 'N/A'}</div>
                        <div style="font-size:20px; color:#64748b;">Date: ${paymentDate} | Time: ${paymentTime}</div>
                    </div>
                    <div style="
                        font-weight:700; font-size:20px;
                        background: linear-gradient(45deg,#10b981,#059669);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                    ">₹${amountPaid.toLocaleString('en-IN', { minimumFractionDigits: 2 })}</div>
                `;
                        cardsWrapper.appendChild(card);
                    });

                    // Total amount card
                    const totalCard = document.createElement('div');
                    totalCard.style.cssText = `
                background: linear-gradient(145deg,#6366f1,#4338ca); color:#fff;
                padding:20px 25px; border-radius:18px; font-weight:700; font-size:20px;
                text-align:right; box-shadow:0 6px 20px rgba(0,0,0,0.15);
            `;
                    totalCard.textContent = `Total Paid: ₹${totalAmountPaid.toLocaleString('en-IN', { minimumFractionDigits: 2 })}`;
                    cardsWrapper.appendChild(totalCard);

                } else {
                    const noData = document.createElement('div');
                    noData.textContent = 'No payment history found.';
                    noData.style.cssText = 'padding:20px; text-align:center; color:#334155; font-weight:600;';
                    cardsWrapper.appendChild(noData);
                }

            } catch (error) {
                console.error('Error fetching payment history:', error);
                const errorDiv = document.createElement('div');
                errorDiv.textContent = 'Failed to fetch payment history.';
                errorDiv.style.cssText = 'padding:20px; text-align:center; color:#ef4444; font-weight:600;';
                cardsWrapper.appendChild(errorDiv);
            }

            // Close modal on overlay click
            modal.onclick = (event) => {
                if (event.target === modal) modal.remove();
            };
        }

        window.onload = fetchBills;
    </script>
</body>

</html>