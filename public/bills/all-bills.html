<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Bills -Sri Vasavi Jewellers</title>
    <link rel="stylesheet" href="all-bills.css">
    <link rel="icon" href="logo.png" type="image/x-icon">
</head>

<body>
    <header class="header">
        <button class="back-button" onclick="window.history.back()">Back</button>
        <h1>All Bills </h1>
    </header>
    <div class="container">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search bills..." oninput="searchBills()">
            <button id="searchButton" onclick="searchBills()">Search</button>
        </div>
        <table class="bills-table">
            <thead>
                <tr>
                    <th>Bill Number</th>
                    <th>Customer Name</th>
                    <th>Phone</th>
                    <th>Bill Date</th>
                    <th>Subtotal</th>
                    <th>Discount</th>
                    <th>Amount Paid</th>
                    <th>OG Amount</th>
                    <th>Old Balance</th>
                    <th>Balance</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="bill-data">
                <!-- Dynamic content will be inserted here -->
            </tbody>
        </table>
    </div>
    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Payment History</h2>
            <table id="historyTable" class="history-table">
                <thead>
                    <tr>
                        <th>Sub-Bill Number</th>
                        <th>Amount Paid</th>
                        <th>Payment Date</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- History rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
    <div id="billsContainer">
        <!-- Buttons will be generated here -->
    </div>
    <!-- Modal Structure -->
    <div id="itemsModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close-items">&times;</span>
            <h2>Items</h2>
            <table id="itemsTable" class="history-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Item Name</th>
                        <th>Quantity</th>
                        <th>Amount per Gram</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be populated here -->
                </tbody>
            </table>
        </div>
    </div>
    <!-- Notification Container -->
    <div id="notification" class="notification">
        <p id="notificationMessage"></p>
        <button id="notificationClose" class="close-btn">X</button>
    </div>

    <script>
        function uploadOldBill(billNumber) {
            if (!billNumber) {
                showNotification("Error: Bill number is missing.", "error");
                return;
            }

            // Create overlay
            const overlay = document.createElement("div");
            overlay.style.position = "fixed";
            overlay.style.top = "0";
            overlay.style.left = "0";
            overlay.style.width = "100vw";
            overlay.style.height = "100vh";
            overlay.style.background = "rgba(0, 0, 0, 0.5)";
            overlay.style.display = "flex";
            overlay.style.justifyContent = "center";
            overlay.style.alignItems = "center";
            overlay.style.zIndex = "10000";

            // Create modal
            const modal = document.createElement("div");
            modal.style.background = "#fff";
            modal.style.padding = "30px";
            modal.style.borderRadius = "12px";
            modal.style.textAlign = "center";
            modal.style.boxShadow = "0px 4px 10px rgba(0, 0, 0, 0.2)";

            const title = document.createElement("h2");
            title.innerText = "Choose an option:";
            modal.appendChild(title);

            // 📸 Take a Photo Button
            const cameraButton = document.createElement("button");
            cameraButton.innerText = "📸 Take a Photo";
            styleButton(cameraButton, "#4CAF50");
            cameraButton.onclick = () => {
                document.body.removeChild(overlay);
                openCamera(billNumber);
            };
            modal.appendChild(cameraButton);

            // 📁 Upload from Device Button
            const uploadButton = document.createElement("button");
            uploadButton.innerText = "📁 Upload from Device";
            styleButton(uploadButton, "#2196F3");
            uploadButton.onclick = () => {
                document.body.removeChild(overlay);
                openFileInput(billNumber);
            };
            modal.appendChild(uploadButton);

            // Append modal to overlay
            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            // Close modal when clicking outside
            overlay.addEventListener("click", (event) => {
                if (event.target === overlay) {
                    document.body.removeChild(overlay);
                }
            });

            function styleButton(button, bgColor) {
                button.style.padding = "15px 30px";
                button.style.fontSize = "18px";
                button.style.margin = "10px";
                button.style.width = "250px";
                button.style.border = "none";
                button.style.background = bgColor;
                button.style.color = "#fff";
                button.style.borderRadius = "8px";
                button.style.cursor = "pointer";
                button.style.fontWeight = "bold";
                button.style.transition = "0.3s";
                button.style.boxShadow = "0 4px 8px rgba(0, 0, 0, 0.2)";
                button.onmouseover = () => (button.style.opacity = "0.8");
                button.onmouseout = () => (button.style.opacity = "1");
            }
        }

        function openCamera(billNumber) {
            if (!billNumber) {
                showNotification("Error: Bill number is missing.", "error");
                return;
            }

            // Create overlay for camera
            const overlay = document.createElement("div");
            overlay.style.position = "fixed";
            overlay.style.top = "0";
            overlay.style.left = "0";
            overlay.style.width = "100vw";
            overlay.style.height = "100vh";
            overlay.style.background = "rgba(0, 0, 0, 0.6)";
            overlay.style.display = "flex";
            overlay.style.justifyContent = "center";
            overlay.style.alignItems = "center";
            overlay.style.zIndex = "10000";

            // Create modal container (Increased size)
            const modal = document.createElement("div");
            modal.style.background = "#fff";
            modal.style.padding = "20px";
            modal.style.borderRadius = "12px";
            modal.style.textAlign = "center";
            modal.style.position = "relative";
            modal.style.maxWidth = "800px";  // Increased width
            modal.style.width = "90%";
            modal.style.boxShadow = "0px 8px 16px rgba(0, 0, 0, 0.2)";
            modal.style.display = "flex";
            modal.style.flexDirection = "column";
            modal.style.alignItems = "center";

            const video = document.createElement("video");
            video.style.width = "100%";
            video.style.borderRadius = "8px";
            video.autoplay = true;
            modal.appendChild(video);

            // Capture button
            const captureButton = document.createElement("button");
            captureButton.innerText = "📸 Capture";
            captureButton.style.marginTop = "15px";
            captureButton.style.padding = "12px 25px";
            captureButton.style.fontSize = "18px";
            captureButton.style.fontWeight = "bold";
            captureButton.style.background = "#FF5722";
            captureButton.style.color = "#fff";
            captureButton.style.border = "none";
            captureButton.style.borderRadius = "8px";
            captureButton.style.cursor = "pointer";
            captureButton.style.width = "100%";
            captureButton.style.maxWidth = "250px";
            captureButton.style.boxShadow = "0px 4px 8px rgba(0, 0, 0, 0.1)";
            modal.appendChild(captureButton);

            overlay.appendChild(modal);
            document.body.appendChild(overlay);

            let stream = null;

            // Close overlay on clicking outside the modal
            overlay.addEventListener("click", (event) => {
                if (event.target === overlay) {
                    stopCameraStream();
                    document.body.removeChild(overlay);
                }
            });

            // Start camera
            function startCamera() {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then((cameraStream) => {
                        stream = cameraStream;
                        video.srcObject = stream;

                        // Wait until video metadata is loaded
                        video.onloadedmetadata = () => {
                            video.play();
                        };
                    })
                    .catch(() => {
                        showNotification("Camera access denied.", "error");
                        document.body.removeChild(overlay);
                    });
            }

            startCamera();

            captureButton.onclick = () => {
                if (!video.videoWidth || !video.videoHeight) {
                    showNotification("Camera is not ready yet. Please try again.", "error");
                    return;
                }

                // Create canvas to capture image
                const canvas = document.createElement("canvas");
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext("2d");

                // Ensure the camera frame is fully loaded before capturing
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                // Stop video stream
                stopCameraStream();

                // Remove video element and capture button
                modal.innerHTML = "";

                // Display captured image
                const imagePreview = document.createElement("img");
                imagePreview.src = canvas.toDataURL("image/jpeg");
                imagePreview.style.width = "100%";
                imagePreview.style.borderRadius = "8px";
                modal.appendChild(imagePreview);

                // Create button container (Proper design)
                const buttonContainer = document.createElement("div");
                buttonContainer.style.display = "flex";
                buttonContainer.style.justifyContent = "space-between";
                buttonContainer.style.marginTop = "20px";
                buttonContainer.style.width = "100%";

                // Recapture button (Blue)
                const recaptureButton = document.createElement("button");
                recaptureButton.innerText = "🔄 Recapture";
                recaptureButton.style.padding = "12px 20px";
                recaptureButton.style.background = "#2196F3";
                recaptureButton.style.color = "#fff";
                recaptureButton.style.border = "none";
                recaptureButton.style.borderRadius = "8px";
                recaptureButton.style.cursor = "pointer";
                recaptureButton.style.fontSize = "16px";
                recaptureButton.style.fontWeight = "bold";
                recaptureButton.style.flex = "1";
                recaptureButton.style.marginRight = "10px";
                recaptureButton.style.boxShadow = "0px 4px 8px rgba(0, 0, 0, 0.1)";
                recaptureButton.onclick = () => {
                    stopCameraStream(); // Ensure old stream is stopped
                    document.body.removeChild(overlay);
                    openCamera(billNumber); // Restart camera
                };

                // Upload button (Green)
                const uploadButton = document.createElement("button");
                uploadButton.innerText = "📤 Upload";
                uploadButton.style.padding = "12px 20px";
                uploadButton.style.background = "#4CAF50";
                uploadButton.style.color = "#fff";
                uploadButton.style.border = "none";
                uploadButton.style.borderRadius = "8px";
                uploadButton.style.cursor = "pointer";
                uploadButton.style.fontSize = "16px";
                uploadButton.style.fontWeight = "bold";
                uploadButton.style.flex = "1";
                uploadButton.style.marginLeft = "10px";
                uploadButton.style.boxShadow = "0px 4px 8px rgba(0, 0, 0, 0.1)";
                uploadButton.onclick = () => {
                    uploadCapturedImage(canvas, billNumber);
                    document.body.removeChild(overlay);
                };

                // Append buttons
                buttonContainer.appendChild(recaptureButton);
                buttonContainer.appendChild(uploadButton);
                modal.appendChild(buttonContainer);
            };

            function stopCameraStream() {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null; // Ensure stream is properly cleared
                }
            }
        }

        // 📤 Upload Captured Image
        function uploadCapturedImage(canvas, billNumber) {
            canvas.toBlob(async (blob) => {
                const formData = new FormData();
                formData.append("billNumber", billNumber);
                formData.append("billImages", blob, "captured_image.jpg");

                try {
                    const response = await fetch("/upload-old-bill", { method: "POST", body: formData });
                    const data = await response.json();
                    showNotification(data.message, data.success ? "success" : "error");
                } catch (error) {
                    showNotification("Upload failed. Please try again.", "error");
                }
            }, "image/jpeg");
        }
        // 📂 Open File Picker
        function openFileInput(billNumber) {
            if (!billNumber) {
                showNotification("Error: Bill number is missing.", "error");
                return;
            }

            const input = document.createElement("input");
            input.type = "file";
            input.accept = "image/*";
            input.multiple = true;

            input.addEventListener("change", async (event) => {
                const files = event.target.files;
                if (!files.length) {
                    showNotification("No file selected.", "error");
                    return;
                }

                const formData = new FormData();
                formData.append("billNumber", billNumber);

                for (const file of files) {
                    formData.append("billImages", file);
                }

                try {
                    const response = await fetch("/upload-old-bill", { method: "POST", body: formData });
                    const data = await response.json();
                    showNotification(data.message, data.success ? "success" : "error");
                } catch (error) {
                    showNotification("Upload failed. Please try again.", "error");
                }
            });

            input.click();
        }

        function showNotification(message, type) {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notificationMessage');
            notificationMessage.innerText = message;

            // Set the class for notification type (success or error)
            notification.className = 'notification ' + (type || 'success') + ' show';

            // Display the notification
            notification.style.display = 'block';

            // Hide the notification after 5 seconds
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                    notification.style.display = 'none';
                    notification.style.opacity = '1'; // Reset for next use
                    notification.style.transform = 'translateY(0)';
                }, 300); // Allow fade-out animation to complete
            }, 5000); // Hide after 5 seconds
        }

        function viewOldBillImages(billNumber) {
            fetch(`/bill-images/${billNumber}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove existing modal if present
                        const existingModal = document.getElementById("imageModal");
                        if (existingModal) existingModal.remove();

                        // Create full-screen modal
                        const modal = document.createElement("div");
                        modal.id = "imageModal";
                        modal.className = "modal-overlay";

                        // Image container
                        const imageContainer = document.createElement("div");
                        imageContainer.className = "image-container";

                        // Append images
                        data.images.forEach(base64Image => {
                            const img = document.createElement("img");
                            img.src = `data:image/jpeg;base64,${base64Image}`;
                            img.className = "bill-image";

                            // Show single image on click
                            img.onclick = (event) => {
                                event.stopPropagation(); // Prevent closing modal when clicking on image
                                openSingleImageView(img.src);
                            };

                            imageContainer.appendChild(img);
                        });

                        // Append elements
                        modal.appendChild(imageContainer);
                        document.body.appendChild(modal);

                        // Close on clicking anywhere
                        modal.onclick = () => modal.remove();
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: 'No Images Found!',
                            text: 'There are no images associated with this bill.',
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(error => console.error("Error fetching images:", error));
        }

        // Function to display a single image in full-screen with zoom & drag
        function openSingleImageView(imageSrc) {
            // Remove existing full-image modal if present
            const existingFullImage = document.getElementById("fullImageModal");
            if (existingFullImage) existingFullImage.remove();

            // Create modal for single image view
            const modal = document.createElement("div");
            modal.id = "fullImageModal";
            modal.className = "full-image-overlay";

            const img = document.createElement("img");
            img.src = imageSrc;
            img.className = "full-image";

            // Zoom functionality
            let scale = 1;
            let isDragging = false;
            let startX, startY, translateX = 0, translateY = 0;

            // Scroll to Zoom In/Out
            img.addEventListener("wheel", (event) => {
                event.preventDefault();
                const zoomIntensity = 0.1;
                scale += event.deltaY < 0 ? zoomIntensity : -zoomIntensity;
                scale = Math.max(1, scale); // Prevent negative zoom
                img.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
            });

            // Drag to Move when Zoomed
            img.addEventListener("mousedown", (event) => {
                if (scale > 1) {
                    isDragging = true;
                    startX = event.clientX - translateX;
                    startY = event.clientY - translateY;
                    img.style.cursor = "grabbing";
                }
            });

            window.addEventListener("mousemove", (event) => {
                if (isDragging) {
                    translateX = event.clientX - startX;
                    translateY = event.clientY - startY;
                    img.style.transform = `scale(${scale}) translate(${translateX}px, ${translateY}px)`;
                }
            });

            window.addEventListener("mouseup", () => {
                isDragging = false;
                img.style.cursor = "grab";
            });

            modal.appendChild(img);
            document.body.appendChild(modal);

            // Close on clicking anywhere
            modal.onclick = () => modal.remove();
        }

        async function modifyBill(billNumber) {
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(5px);
        `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
            background: linear-gradient(145deg, #ffffff, #f8f9fa);
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 90%;
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        `;

            const fields = [
                { name: 'subtotal', label: 'Subtotal', icon: '💰' },
                { name: 'discount', label: 'Discount', icon: '🏷️' },
                { name: 'amount_paid', label: 'Amount Paid', icon: '💵' },
                { name: 'oldGold', label: 'Old Gold/Silver Amount', icon: '✨' },
                { name: 'old_balance', label: 'Old Balance', icon: '📊' },
                { name: 'balance_amount', label: 'Balance Amount', icon: '💳' }
            ];

            modalContent.innerHTML = `
            <style>
                @keyframes ripple {
                    0% { transform: scale(0); opacity: 1; }
                    100% { transform: scale(4); opacity: 0; }
                }
                
                .modify-field {
                    margin-bottom: 20px;
                    padding: 20px;
                    border-radius: 16px;
                    background: rgba(255, 255, 255, 0.9);
                    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    border: 1px solid rgba(0, 77, 64, 0.1);
                    position: relative;
                    overflow: hidden;
                }

                .modify-field:hover {
                    background: rgba(255, 255, 255, 1);
                    transform: translateY(-3px) scale(1.02);
                    box-shadow: 0 8px 25px rgba(0, 77, 64, 0.15);
                    border-color: #004d40;
                }

                .field-icon {
                    font-size: 24px;
                    margin-right: 15px;
                    opacity: 0.9;
                }

                .modify-field-label {
                    font-size: 18px;
                    font-weight: 600;
                    color: #004d40;
                    display: flex;
                    align-items: center;
                }

                .modify-btn {
                    background: linear-gradient(145deg, #004d40, #00796b);
                    color: white;
                    border: none;
                    padding: 12px 24px;
                    border-radius: 12px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    font-weight: 600;
                    letter-spacing: 0.5px;
                    position: relative;
                    overflow: hidden;
                }

                .modify-btn:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 20px rgba(0, 77, 64, 0.2);
                }

                .modify-btn:active {
                    transform: translateY(1px);
                }

                .close-btn {
                    position: absolute;
                    top: 20px;
                    right: 20px;
                    background: rgba(255, 255, 255, 0.9);
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                    color: #004d40;
                    width: 40px;
                    height: 40px;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.3s ease;
                }

                .close-btn:hover {
                    background: #004d40;
                    color: white;
                    transform: rotate(90deg);
                }

                .modal-header {
                    background: linear-gradient(145deg, #004d40, #00796b);
                    margin: -40px -40px 30px -40px;
                    padding: 30px;
                    color: white;
                    border-radius: 25px 25px 0 0;
                    text-align: center;
                    box-shadow: 0 4px 20px rgba(0, 77, 64, 0.2);
                }
            </style>
            <button class="close-btn">&times;</button>
            <div class="modal-header">
                <h3 style="margin: 0; font-size: 28px; font-weight: 700;">
                    Modify Bill #${billNumber}
                </h3>
            </div>
            ${fields.map(field => `
                <div class="modify-field">
                    <span class="modify-field-label">
                        <span class="field-icon">${field.icon}</span>
                        ${field.label}
                    </span>
                    <button class="modify-btn" onclick="modifyField('${billNumber}', '${field.name}')">
                        Modify
                    </button>
                </div>
            `).join('')}
        `;

            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            // Close handlers
            const closeModal = () => {
                modalOverlay.style.animation = 'fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) reverse';
                modalContent.style.animation = 'slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) reverse';
                setTimeout(() => modalOverlay.remove(), 380);
            };

            modalOverlay.addEventListener('click', (e) => {
                if (e.target === modalOverlay) closeModal();
            });

            modalContent.querySelector('.close-btn').onclick = closeModal;

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal();
            });
        }

        async function modifyField(billNumber, field) {
            // Create modal for value input
            const inputModal = document.createElement('div');
            inputModal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 35px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1001;
            width: 400px;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        `;

            // Fetch current value
            const response = await fetch(`/bill-details/${billNumber}`);
            const billData = await response.json();
            const currentValue = billData[field] || 0;

            inputModal.innerHTML = `
            <div style="position: relative;">
                <h4 style="
                    margin: 0 0 25px; 
                    color: #004d40; 
                    font-size: 20px;
                    font-weight: 600;
                    text-align: center;
                ">
                    Modify ${field.replace(/_/g, ' ').toUpperCase()}
                </h4>
                
                <div style="
                    background: #f5f5f5;
                    padding: 15px;
                    border-radius: 12px;
                    margin-bottom: 20px;
                ">
                    <div style="
                        color: #666;
                        font-size: 14px;
                        margin-bottom: 8px;
                    ">Current Value:</div>
                    <div style="
                        color: #004d40;
                        font-size: 24px;
                        font-weight: 600;
                    ">₹${currentValue.toLocaleString('en-IN')}</div>
                </div>

                <div style="
                    position: relative;
                    margin-bottom: 25px;
                ">
                    <label style="
                        position: absolute;
                        left: 12px;
                        top: -10px;
                        background: white;
                        padding: 0 8px;
                        color: #00796b;
                        font-size: 14px;
                    ">New Value</label>
                    <input type="number" id="valueInput" 
                        style="
                            width: 100%;
                            padding: 15px;
                            border: 2px solid #e0e0e0;
                            border-radius: 12px;
                            font-size: 18px;
                            outline: none;
                            transition: all 0.3s;
                            box-sizing: border-box;
                        "
                        value="${currentValue}"
                        onFocus="this.style.borderColor='#00796b'; this.style.boxShadow='0 0 0 4px rgba(0,121,107,0.1)'"
                        onBlur="this.style.borderColor='#e0e0e0'; this.style.boxShadow='none'"
                    >
                </div>

                <div style="
                    display: flex; 
                    gap: 12px; 
                    justify-content: flex-end;
                ">
                    <button id="cancelBtn" 
                        style="
                            padding: 12px 24px;
                            border: 2px solid #e0e0e0;
                            border-radius: 10px;
                            background: white;
                            cursor: pointer;
                            font-size: 15px;
                            font-weight: 600;
                            color: #666;
                            transition: all 0.3s;
                        "
                        onMouseOver="this.style.backgroundColor='#f5f5f5'; this.style.borderColor='#d0d0d0'"
                        onMouseOut="this.style.backgroundColor='white'; this.style.borderColor='#e0e0e0'"
                    >Cancel</button>
                    <button id="confirmBtn"
                        style="
                            padding: 12px 28px;
                            border: none;
                            border-radius: 10px;
                            background: linear-gradient(145deg, #00796b, #004d40);
                            color: white;
                            cursor: pointer;
                            font-size: 15px;
                            font-weight: 600;
                            transition: all 0.3s;
                            box-shadow: 0 4px 15px rgba(0,121,107,0.2);
                        "
                        onMouseOver="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(0,121,107,0.3)'"
                        onMouseOut="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,121,107,0.2)'"
                    >Save Changes</button>
                </div>
            </div>
        `;

            document.body.appendChild(inputModal);
            const input = document.getElementById('valueInput');
            input.focus();
            input.select();

            const value = await new Promise((resolve) => {
                document.getElementById('cancelBtn').onclick = () => {
                    inputModal.remove();
                    resolve(null);
                };

                document.getElementById('confirmBtn').onclick = () => {
                    const val = input.value;
                    inputModal.remove();
                    resolve(val);
                };

                input.onkeyup = (e) => {
                    if (e.key === 'Enter') {
                        const val = input.value;
                        inputModal.remove();
                        resolve(val);
                    }
                    if (e.key === 'Escape') {
                        inputModal.remove();
                        resolve(null);
                    }
                };
            });
            if (value === null || value === '') return;

            try {
                const response = await fetch('/modify-bill', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        billNumber,
                        field,
                        value: parseFloat(value)
                    })
                });

                if (!response.ok) throw new Error('Failed to modify bill');

                await fetchBills();

                // Show success notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                position: fixed;
                bottom: 40px;
                right: 40px;
                background: linear-gradient(135deg, #00C853, #64DD17);
                color: white;
                padding: 25px 50px;
                border-radius: 20px;
                box-shadow: 0 15px 40px rgba(0, 200, 83, 0.4);
                animation: slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1), pulse 2s infinite;
                z-index: 1000;
                font-size: 20px;
                font-weight: 600;
                letter-spacing: 0.5px;
                display: flex;
                align-items: center;
                gap: 15px;
                border: 3px solid rgba(255, 255, 255, 0.3);
                transform-origin: right bottom;
                min-width: 400px;
                opacity: 1;
            `;
                notification.innerHTML = `
                <div style="
                    background: rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    width: 48px;
                    height: 48px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    margin-right: 12px;
                ">
                    <svg width="30" height="30" viewBox="0 0 24 24" fill="none">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="white"/>
                    </svg>
                </div>
                <div style="
                    display: flex;
                    flex-direction: column;
                    gap: 6px;
                ">
                    <span style="font-weight: 700; font-size: 24px">Success!</span>
                    <span style="font-size: 18px; opacity: 0.9">Bill modified successfully</span>
                </div>
            `;
                document.body.appendChild(notification);

                // Add animation keyframes if not already present
                if (!document.querySelector('#notificationStyles')) {
                    const style = document.createElement('style');
                    style.id = 'notificationStyles';
                    style.textContent = `
                    @keyframes pulse {
                        0% { transform: scale(1); }
                        50% { transform: scale(1.03); }
                        100% { transform: scale(1); }
                    }
                    @keyframes slideIn {
                        from {
                            transform: translateX(100%);
                            opacity: 0;
                        }
                        to {
                            transform: translateX(0);
                            opacity: 1;
                        }
                    }
                `;
                    document.head.appendChild(style);
                }

                setTimeout(() => {
                    notification.style.animation = 'slideIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) reverse';
                    setTimeout(() => notification.remove(), 480);
                }, 3000);

            } catch (error) {
                console.error('Error modifying bill:', error);
                alert('Failed to modify bill. Please try again.');
            }
        }
        async function showItems(billNumber) {
            const modal = document.getElementById('itemsModal');
            const closeModal = document.querySelector('.close-items');
            const itemsTableBody = document.querySelector('#itemsTable tbody');

            try {
                // Fetch the bill items from the server
                const response = await fetch(`/bill-items/${billNumber}`);

                // Check if the response is OK
                if (!response.ok) {
                    // If the response is not OK, throw an error
                    throw new Error('Network response was not ok');
                }

                // Parse the response data
                const data = await response.json();

                // Clear the current table content
                itemsTableBody.innerHTML = '';

                // Ensure that the `items` field in the response is an array
                if (Array.isArray(data.items) && data.items.length > 0) {
                    // Iterate over each item and append rows to the table
                    let rows = '';
                    data.items.forEach(item => {
                        rows += `
                    <tr>
                        <td><strong>${item.sub_item_id}</strong></td>
                        <td><strong>${item.item_name}</strong></td>
                        <td><strong>${item.quantity}gm</strong></td>
                        <td><strong>${item.amount_per_gram}</strong></td>
                    </tr>
                `;
                    });

                    // Insert the rows into the table body
                    itemsTableBody.innerHTML = rows;
                } else {
                    // Handle the case where there are no items
                    itemsTableBody.innerHTML = '<tr><td colspan="3">No items found for this bill</td></tr>';
                }

                // Show the modal
                modal.style.display = 'block';

            } catch (error) {
                // Log any error encountered during the fetch process
                console.error('Error fetching bill items:', error);
            }

            // Close the modal when the user clicks on the close button (x)
            closeModal.onclick = function () {
                modal.style.display = 'none';
            };

            // Close the modal when the user clicks outside the modal content
            window.onclick = function (event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }
        async function showHistory(billNumber) {
            const modal = document.getElementById('historyModal');
            const closeModal = document.querySelector('.close');
            const historyTableBody = document.querySelector('#historyTable tbody');

            try {
                const response = await fetch(`/payment-history/${billNumber}`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                let rows = '';
                let totalAmountPaid = 0;

                if (data.subBills && Array.isArray(data.subBills)) {
                    data.subBills.forEach(subBill => {
                        const amountPaid = parseFloat(subBill.amount_paid);
                        totalAmountPaid += amountPaid;

                        rows += `
                    <tr>
                        <td><strong>${subBill.sub_bill_number || 'N/A'}</strong></td>
                        <td><strong>₹${formatNumber(amountPaid.toFixed(2))}</strong></td>
                        <td><strong>${new Date(subBill.payment_date).toLocaleDateString('en-GB')} ${new Date(subBill.payment_date).toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' })}</strong></td>
                    </tr>
                `;
                    });

                    // Add total amount paid row
                    rows += `
                <tr>
                    <td colspan="2" style="text-align: right; font-weight: bold;">Total Amount Paid:</td>
                    <td style="font-weight: bold;">₹${formatNumber(totalAmountPaid.toFixed(2))}</td>
                </tr>
            `;

                    historyTableBody.innerHTML = rows;
                } else {
                    console.error('Invalid data format:', data);
                }

                // Show the modal
                modal.style.display = 'block';
            } catch (error) {
                console.error('Error fetching payment history:', error);
            }

            // Close the modal when the user clicks on <span> (x)
            closeModal.onclick = function () {
                modal.style.display = 'none';
            }

            // Close the modal when the user clicks anywhere outside of the modal
            window.onclick = function (event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            }
        }
        // Function to format numbers in the Indian numbering system
        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(num);
        }
        function searchBills() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const table = document.querySelector('.bills-table');
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const cells = row.getElementsByTagName('td');
                let match = false;

                for (let i = 0; i < cells.length; i++) {
                    if (cells[i].innerText.toLowerCase().includes(input)) {
                        match = true;
                        break;
                    }
                }

                row.style.display = match ? '' : 'none';
            });
        }

        async function deleteBill(billNumber) {
            // Create modal elements
            const modalOverlay = document.createElement('div');
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.85); 
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 1000;
                backdrop-filter: blur(12px);
                animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
                cursor: pointer;
            `;

            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: linear-gradient(165deg, #ffffff, #f5f7fa);
                padding: 48px;
                border-radius: 32px;
                text-align: center;
                max-width: 520px;
                width: 94%;
                box-shadow: 0 30px 60px -12px rgba(0,0,0,0.3),
                            0 12px 32px -8px rgba(0,0,0,0.2),
                            inset 0 2px 6px rgba(255,255,255,0.9);
                transform: translateY(0);
                animation: slideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
                border: 1px solid rgba(255,255,255,0.22);
                cursor: default;
                position: relative;
                overflow: hidden;
            `;

            modalContent.innerHTML = `
                <style>
                    @keyframes fadeIn {
                        from { opacity: 0; }
                        to { opacity: 1; }
                    }
                    @keyframes slideIn {
                        from { transform: translateY(-40px); opacity: 0; }
                        to { transform: translateY(0); opacity: 1; }
                    }
                    @keyframes pulse {
                        0% { transform: scale(1); }
                        50% { transform: scale(1.08); }
                        100% { transform: scale(1); }
                    }
                    @keyframes glow {
                        0% { box-shadow: 0 0 5px rgba(255,71,87,0.5); }
                        50% { box-shadow: 0 0 20px rgba(255,71,87,0.8); }
                        100% { box-shadow: 0 0 5px rgba(255,71,87,0.5); }
                    }
                    .modal-btn {
                        padding: 16px 32px;
                        border: none;
                        border-radius: 100px;
                        cursor: pointer;
                        font-weight: 700;
                        font-size: 17px;
                        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                        transform: scale(1);
                        margin: 0 12px;
                        letter-spacing: 0.5px;
                        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
                        position: relative;
                        overflow: hidden;
                    }
                    .modal-btn:before {
                        content: '';
                        position: absolute;
                        top: 0;
                        left: -100%;
                        width: 100%;
                        height: 100%;
                        background: linear-gradient(
                            90deg,
                            transparent,
                            rgba(255,255,255,0.2),
                            transparent
                        );
                        transition: 0.5s;
                    }
                    .modal-btn:hover:before {
                        left: 100%;
                    }
                    .modal-btn:hover {
                        transform: scale(1.05) translateY(-2px);
                        box-shadow: 0 8px 20px rgba(0,0,0,0.2);
                    }
                    .modal-btn:active {
                        transform: scale(0.98);
                    }
                    .modal-icon {
                        font-size: 82px;
                        margin-bottom: 28px;
                        animation: pulse 2.5s infinite;
                        text-shadow: 0 6px 16px rgba(255,71,87,0.4);
                        background: linear-gradient(45deg, #ff4757, #ff6b81);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        filter: drop-shadow(0 2px 8px rgba(255,71,87,0.3));
                    }
                    .success-icon {
                        animation: successIcon 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
                        display: inline-block;
                        background: linear-gradient(45deg, #2ecc71, #27ae60);
                        -webkit-background-clip: text;
                        -webkit-text-fill-color: transparent;
                        filter: drop-shadow(0 2px 8px rgba(46,204,113,0.3));
                    }
                </style>
                <div class="modal-icon">🗑️</div>
                <h3 style="margin: 0 0 24px 0; font-size: 32px; color: #2d3436; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.1); letter-spacing: -0.5px;">
                    Delete Bill ${billNumber}
                </h3>
                <p style="margin: 0 0 36px 0; color: #2d3436; font-size: 18px; line-height: 1.7; font-weight: 500; background: linear-gradient(120deg, #f1f3f5, #ffffff); padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.08); text-align: center;">
                    Are you sure you want to delete this bill? This action is permanent and cannot be reversed.
                </p>
                <div style="display: flex; justify-content: center; gap: 24px;">
                    <button id="cancelDelete" class="modal-btn" style="background: linear-gradient(145deg, #f5f6fa, #e9ecef); color: #2d3436;">
                        Cancel
                    </button>
                    <button id="confirmDelete" class="modal-btn" style="background: linear-gradient(145deg, #ff4757, #ff6b81); color: white; animation: glow 2s infinite;">
                        Delete Bill
                    </button>
                </div>
            `;

            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            // Handle modal actions
            return new Promise((resolve) => {
                const closeModal = () => {
                    modalOverlay.style.animation = 'fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) reverse';
                    modalContent.style.animation = 'slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1) reverse';
                    setTimeout(() => {
                        modalOverlay.remove();
                        resolve(false);
                    }, 380);
                };

                // Close on overlay click
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        closeModal();
                    }
                });

                // Close on escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                    }
                });

                document.getElementById('cancelDelete').onclick = closeModal;

                document.getElementById('confirmDelete').onclick = async () => {
                    try {
                        const response = await fetch(`/delete-bill/${billNumber}`, {
                            method: 'DELETE'
                        });

                        if (!response.ok) {
                            throw new Error('Failed to delete bill');
                        }

                        await fetchBills();

                        modalContent.innerHTML = `
                            <style>
                                @keyframes successIcon {
                                    0% { transform: scale(0) rotate(-180deg); }
                                    60% { transform: scale(1.2) rotate(10deg); }
                                    100% { transform: scale(1) rotate(0deg); }
                                }
                                .success-icon {
                                    animation: successIcon 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
                                    display: inline-block;
                                }
                            </style>
                            <div class="success-icon" style="font-size: 88px; margin-bottom: 24px;">✓</div>
                            <h3 style="margin: 15px 0; font-size: 32px; color: #2ecc71; text-shadow: 0 2px 4px rgba(46,204,113,0.2); font-weight: 800;">Success!</h3>
                            <p style="margin: 0 0 36px 0; color: #2d3436; font-size: 18px; line-height: 1.7; font-weight: 500; background: linear-gradient(120deg, #f1f3f5, #ffffff); padding: 20px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.08); text-align: center;">
                                Bill <span style="color: #00b894; font-weight: 700;">${billNumber}</span> has been successfully deleted.
                            </p>
                            <button id="closeModal" class="modal-btn" style="background: linear-gradient(145deg, #2ecc71, #27ae60); color: white; padding: 16px 42px;">
                                Close
                            </button>
                        `;

                        document.getElementById('closeModal').onclick = closeModal;

                    } catch (error) {
                        console.error('Error deleting bill:', error);
                        modalContent.innerHTML = `
                            <div style="color: #ff4757; font-size: 88px; animation: pulse 2s infinite;">⚠️</div>
                            <h3 style="margin: 15px 0; font-size: 32px; color: #ff4757; text-shadow: 0 2px 4px rgba(255,71,87,0.2); font-weight: 800;">Error</h3>
                            <p style="margin: 0 0 36px 0; color: #636e72; font-size: 18px; line-height: 1.7;">
                                Failed to delete bill. Please try again.
                            </p>
                            <button id="closeModal" class="modal-btn" style="background: linear-gradient(145deg, #ff4757, #ff6b81); color: white; padding: 16px 42px;">
                                Close
                            </button>
                        `;

                        document.getElementById('closeModal').onclick = closeModal;
                    }
                };
            });
        }

        // Fetching bills from the server and populating the table
        async function fetchBills() {
            try {
                const response = await fetch('/bills1');
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                const data = await response.json();

                // Debugging output to check the structure of the data
                console.log('Fetched bills data:', data);

                const tableBody = document.getElementById('bill-data');
                if (data.bills && Array.isArray(data.bills)) {
                    let rows = '';

                    data.bills.forEach(bill => {
                        rows += `
                            <tr>
                                <td>${bill.bill_number}</td>
                                <td>${bill.customer_name}</td>
                                <td>${bill.customer_phone}</td>
                                <td>${new Date(bill.bill_date).toLocaleDateString('en-GB')}</td>
                                <td>₹${formatNumber(bill.subtotal.toFixed(2))}</td>
                                <td>₹${formatNumber(bill.discount.toFixed(2))}</td>
                                <td>₹${formatNumber(bill.amount_paid.toFixed(2))}</td>
                                <td>₹${formatNumber(bill.oldGold.toFixed(2))}</td>
                                <td>₹${formatNumber(bill.old_balance.toFixed(2))}</td>
                                <td>₹${formatNumber(bill.balance_amount.toFixed(2))}</td>
                                <td>
  <div class="dropdown">
    <button class="dropdown-btn" onclick="openDropdown('${bill.bill_number}')">Actions ▼</button>
  </div>

  <!-- Full-Screen Centered Dropdown -->
  <div id="dropdown-modal-${bill.bill_number}" class="dropdown-modal">
    <div class="dropdown-content">
      <span class="close-btn" onclick="closeDropdown('${bill.bill_number}')">&times;</span>

      <!-- ✅ Dynamic Heading -->
      <h3 class="dropdown-heading">Action for Bill - ${bill.bill_number}</h3>

      <a href="#" onclick="showItems('${bill.bill_number}')">📦 Items</a>
      <a href="#" onclick="viewBill('${bill.bill_number}')">🧾 View Bill</a>
      <a href="#" onclick="deleteBill('${bill.bill_number}')" class="delete">🗑️ Delete</a>
      <a href="#" onclick="modifyBill('${bill.bill_number}')">✏️ Edit</a>
      <a href="#" onclick="uploadOldBill('${bill.bill_number}')">📤 Upload Old Bill</a>
      <a href="#" onclick="viewOldBillImages('${bill.bill_number}')">🖼️ View Images</a>
    </div>
  </div>
</td>



                            </tr>
                        `;
                    });

                    tableBody.innerHTML = rows;
                } else {
                    console.error('Invalid data format:', data);
                }
            } catch (error) {
                console.error('Error fetching bills:', error);
            }
        }
        function viewBill(billNumber) {
            // Redirect to the specific bill page with the respective bill number
            window.open(`http://localhost:3000/generate-bill/purchase-print-bill.html?billNumber=${billNumber}`, '_blank');
        }
        function openDropdown(billNumber) {
            let modal = document.getElementById(`dropdown-modal-${billNumber}`);
            if (modal) {
                modal.style.display = "flex";
            }
        }

        function closeDropdown(billNumber) {
            let modal = document.getElementById(`dropdown-modal-${billNumber}`);
            if (modal) {
                modal.style.display = "none";
            }
        }

        // Close when clicking outside the dropdown
        window.onclick = function (event) {
            let modals = document.querySelectorAll(".dropdown-modal");
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = "none";
                }
            });
        };

        window.onload = fetchBills;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</body>

</html>
<!-- <td><button onclick="showHistory('${bill.bill_number}')">History</button></td> -->