<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Orders - Sri Vasavi Jewellers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="logo.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Custom Styles for Consistency */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f7fafc;
        }

        /* 1. Base table styling (for Web/Tablet) */
        .ordersTable th,
        .ordersTable td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
            white-space: nowrap; /* Prevents wrapping on all screens */
        }

        .ordersTable th {
            background-color: #edf2f7;
            font-weight: 700;
            color: #4a5568;
        }

        .ordersTable tr:hover {
            background-color: #f5f5f5;
        }

        /* 2. EXTREME MOBILE COMPACTNESS - APPLIES ONLY TO PHONES (<768px) */
        @media (max-width: 767px) {
            .ordersTable th,
            .ordersTable td {
                padding: 8px 4px; /* Reduced padding */
                font-size: 0.75rem; /* Smaller text size */
            }
        }
        
        .action-button {
            padding: 8px 10px; 
            border-radius: 9999px;
            font-size: 0.75rem; 
            font-weight: 600;
            transition: all 0.3s ease;
        }

        /* Status Colors */
        .status-button.pending {
            background-color: #f6ad55;
            color: white;
        }

        .status-button.delivered {
            background-color: #48bb78;
            color: white;
            cursor: default;
        }

        .delivery-status.delivered {
            background-color: #48bb78;
            color: white;
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            display: inline-block;
            line-height: 1;
        }
        
        /* General Modal Overlay for all custom modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        /* 3. ENSURE HIDDEN COLUMNS ARE VISIBLE ON TABLET/WEB (>= 768px) */
        /* This is the key fix to make the full table appear on medium screens up */
        @media (min-width: 768px) {
            .md\:table-cell.hidden {
                display: table-cell !important;
            }
            .md\:hidden {
                display: none !important; /* Hide the mobile 'More' button on web/tablet */
            }
        }
    </style>
</head>

<body>
    <div class="min-h-screen bg-gray-100 p-4 md:p-8">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-gray-200">
    <h1 class="text-3xl font-extrabold text-gray-800">View Orders</h1>
    <div class="flex flex-row gap-3">
        <a href="/admin-welcome.html
        "
            class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition duration-300">
            Dashboard
        </a>
        <a href="order-slip.html"
            class="px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
            Back
        </a>
    </div>
</header>

        <div class="container mx-auto">
            <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg mb-8">
                <div class="flex flex-col md:flex-row gap-4 mb-6">
                    <input type="text" id="searchInput" placeholder="Search Orders by ID, Name, or Phone..."
                        oninput="searchBills()"
                        class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring focus:ring-blue-200 transition duration-150">
                    <button id="searchButton" onclick="searchBills()"
                        class="p-3 bg-blue-500 text-white rounded-lg font-semibold hover:bg-blue-600 transition duration-150 md:w-auto w-full">
                        üîç Search
                    </button>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Orders List</h2>

                <div class="rounded-lg border border-gray-200">
                    <table id="ordersTable" class="ordersTable min-w-full">
                        <thead>
                            <tr>
                                <th class="whitespace-nowrap">Order ID</th>
                                <th>Name</th>
                                <th class="md:table-cell hidden whitespace-nowrap">Customer Phone</th>
                                <th class="md:table-cell hidden whitespace-nowrap">Order Date</th>
                                <th class="md:table-cell hidden whitespace-nowrap">Total Amt</th>
                                <th class="md:table-cell hidden whitespace-nowrap">Advance Paid</th>
                                
                                <th class="whitespace-nowrap">Balance Amt</th>
                                
                                <th class="md:table-cell hidden whitespace-nowrap">View Items</th>
                                <th class="md:table-cell hidden whitespace-nowrap">Actions</th>
                                <th class="md:table-cell hidden whitespace-nowrap">Payment</th>
                                <th class="md:table-cell hidden whitespace-nowrap">Transactions</th>
                                <th class="md:table-cell hidden whitespace-nowrap">Delivery Status</th>
                                
                                <th class="md:hidden">More</th> 
                            </tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="itemsModal" class="modal-overlay hidden" onclick="closeItemsModal()">
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-2xl max-h-[90vh] overflow-y-auto w-[95%] lg:w-[80%]"
            onclick="event.stopPropagation()">
            <h3 class="text-xl md:text-2xl font-bold mb-4 text-gray-800 border-b pb-2">üì¶ Order Items</h3>
            
            <div class="overflow-x-auto"> 
                <table id="itemsTable" class="min-w-full text-xs md:text-sm">
                    <thead>
                        <tr>
                            <th class="py-2 px-3 bg-gray-100 whitespace-nowrap">Type</th>
                            <th class="py-2 px-3 bg-gray-100 whitespace-nowrap">Name</th>
                            <th class="py-2 px-3 bg-gray-100">Qty</th>
                            <th class="py-2 px-3 bg-gray-100 whitespace-nowrap">Amt/g</th>
                            <th class="py-2 px-3 bg-gray-100 whitespace-nowrap">Making Chgs</th>
                            <th class="py-2 px-3 bg-gray-100">Wastage</th>
                            <th class="py-2 px-3 bg-gray-100 whitespace-nowrap">Description</th>
                            <th class="py-2 px-3 bg-gray-100 whitespace-nowrap">Total Amt</th>
                            <th class="py-2 px-3 bg-gray-100 whitespace-nowrap">Status</th>
                            <th class="py-2 px-3 bg-gray-100">Images</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
            
            <button onclick="closeItemsModal()"
                class="mt-4 md:mt-6 px-6 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition duration-300">
                Close
            </button>
        </div>
    </div>

    <div id="moreActionsModal" class="modal-overlay hidden" onclick="closeMoreActionsModal()">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-80" onclick="event.stopPropagation()">
            <h3 class="text-xl font-bold mb-4 text-gray-800 border-b pb-2">More Details & Actions</h3>
            <div id="moreActionsContent" class="space-y-3">
                </div>
            <button onclick="closeMoreActionsModal()"
                class="mt-6 w-full px-4 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition duration-300">
                Close
            </button>
        </div>
    </div>

    <div id="paymentSuccessToast"
        class="hidden fixed bottom-5 right-5 bg-green-500 text-white px-6 py-3 rounded-xl shadow-lg font-semibold transition duration-500 transform translate-y-0 z-50">
        ‚úÖ Payment Successful!
    </div>
    
    <script>
        // --- Core Utility Functions ---

        function searchBills() {
            const input = document.getElementById('searchInput').value.toLowerCase();
            const table = document.querySelector('.ordersTable');
            const rows = table.querySelectorAll('tbody tr');

            rows.forEach(row => {
                const cells = row.querySelectorAll('td');
                let match = false;

                // Check key fields: Order ID (0), Customer Name (1), Phone (2, which is hidden on mobile but searched)
                for (let i = 0; i < Math.min(cells.length, 3); i++) {
                    if (cells[i].innerText.toLowerCase().includes(input)) {
                        match = true;
                        break;
                    }
                }
                row.style.display = match ? '' : 'none';
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}-${month}-${year}`;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('en-IN').format(num);
        }

        function viewOrder(orderId) {
            // window.open(`print-bill.html?orderNumber=${orderId}`, '_blank');
            window.location.href="print-bill.html?orderNumber=" + orderId;
        }

        function closeItemsModal() {
            document.getElementById('itemsModal').classList.add('hidden');
        }

        function closeMoreActionsModal() {
            document.getElementById('moreActionsModal').classList.add('hidden');
        }

        function showPaymentToast() {
            const toast = document.getElementById('paymentSuccessToast');
            toast.classList.remove('hidden');

            setTimeout(() => {
                toast.classList.add('hidden');
            }, 2800);
        }

        // --- Data & Display Functions ---

        let allOrders = []; // Store fetched orders globally

        function createMoreActionsContent(order) {
            // Check if items array is available and all items are delivered
            const allDelivered = order.items && order.items.every(item => item.delivery_status === 'delivered');
            const statusHtml = allDelivered ?
                `<span class="delivery-status delivered">Delivered</span>` :
                `<span class="delivery-status pending" style="background-color: #f6ad55; color: white; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem; display: inline-block; line-height: 1;">Items Pending</span>`;

            const paymentButtonHtml = order.balance_amount > 0 ?
                `<button class="action-button w-full bg-yellow-500 text-white hover:bg-yellow-600" onclick="makeAdvancePayment(${order.id}, ${order.balance_amount.toFixed(2)}); closeMoreActionsModal();">üí∞ Make Payment</button>` :
                `<button class="action-button w-full bg-green-500 text-white cursor-default" disabled>‚úîÔ∏è Fully Paid</button>`;

            return `
                <p class="text-sm text-gray-600"><strong class="font-bold">Phone:</strong> ${order.customer_phone}</p>
                <p class="text-sm text-gray-600"><strong class="font-bold">Date:</strong> ${formatDate(order.order_date)}</p>
                <p class="text-sm text-gray-600"><strong class="font-bold">Total:</strong> ‚Çπ${formatNumber(order.subtotal.toFixed(2))}</p>
                <p class="text-sm text-gray-600"><strong class="font-bold">Advance:</strong> ‚Çπ${formatNumber(order.advance_payment.toFixed(2))}</p>
                <p class="text-sm text-gray-600"><strong class="font-bold">Status:</strong> ${statusHtml}</p>
                <hr class="my-2">
                <button class="action-button w-full bg-gray-200 hover:bg-gray-300 text-gray-800" onclick="viewItems(${order.id}); closeMoreActionsModal();">üîé View Items</button>
                <button class="action-button w-full bg-green-500 text-white hover:bg-green-600" onclick="viewOrder(${order.id}); closeMoreActionsModal();">üñ®Ô∏è Print Bill</button>
                ${paymentButtonHtml}
                <button class="action-button w-full bg-purple-500 text-white hover:bg-purple-600" onclick="viewAdvanceHistory(${order.id}); closeMoreActionsModal();">üßæ View Transactions</button>
            `;
        }
        
        function showMoreActions(orderId) {
            const order = allOrders.find(o => o.id === orderId);
            if (!order) return;

            // Fetch items to check delivery status before showing modal
            fetch(`/fetch-order/${orderId}`)
                .then(response => response.json())
                .then(orderData => {
                    const moreActionsContent = document.getElementById('moreActionsContent');
                    order.items = orderData.items; // Attach items to the global order object
                    moreActionsContent.innerHTML = createMoreActionsContent(order);
                    document.getElementById('moreActionsModal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error fetching order items for modal:', error);
                    alert('Could not fetch order details.');
                });
        }

        document.addEventListener('DOMContentLoaded', () => {
            fetch('/fetch-orders')
                .then(response => response.json())
                .then(data => {
                    allOrders = data; 
                    const tableBody = document.querySelector('#ordersTable tbody');
                    tableBody.innerHTML = '';
                    
                    data.forEach(order => {
                        const row = document.createElement('tr');
                        row.setAttribute('data-order-id', order.id);

                        // Fetch items to determine delivery status
                        fetch(`/fetch-order/${order.id}`)
                            .then(response => response.json())
                            .then(orderData => {
                                // Update allOrders with item data for 'More' button logic
                                const globalOrder = allOrders.find(o => o.id === order.id);
                                if (globalOrder) {
                                    globalOrder.items = orderData.items;
                                }

                                const allDelivered = orderData.items.every(item => item.delivery_status === 'delivered');
                                const statusHtml = allDelivered ?
                                    '<div class="delivery-status delivered">‚úì</div>' :
                                    '<div class="delivery-status pending" style="background-color:#f6ad55; color:white; padding: 4px 8px; border-radius: 9999px; font-size: 0.75rem; display: inline-block; line-height: 1;">...</div>';

                                const payButton = order.balance_amount > 0 ?
                                    `<button class="action-button bg-yellow-500 text-white hover:bg-yellow-600" onclick="makeAdvancePayment(${order.id}, ${order.balance_amount.toFixed(2)})">Pay</button>` :
                                    `<button class="action-button bg-green-500 text-white cursor-default" disabled>‚úîÔ∏è Paid</button>`;
                                    
                                row.innerHTML = `
                                    <td class="whitespace-nowrap">${order.id}</td>
                                    <td>${order.customer_name}</td>
                                    <td class="md:table-cell hidden">${order.customer_phone}</td>
                                    <td class="md:table-cell hidden">${formatDate(order.order_date)}</td>
                                    <td class="md:table-cell hidden">‚Çπ${formatNumber(order.subtotal.toFixed(2))}</td>
                                    <td class="md:table-cell hidden">‚Çπ${formatNumber(order.advance_payment.toFixed(2))}</td>
                                    <td>‚Çπ${formatNumber(order.balance_amount.toFixed(2))}</td>
                                    <td class="md:table-cell hidden"><button class="action-button bg-gray-200 hover:bg-gray-300 text-gray-800" onclick="viewItems(${order.id})">Items</button></td>
                                    <td class="md:table-cell hidden"><button class="action-button bg-green-500 text-white hover:bg-green-600" onclick="viewOrder(${order.id})">Print</button></td>
                                    <td class="md:table-cell hidden">${payButton}</td>
                                    <td class="md:table-cell hidden"><button class="action-button bg-purple-500 text-white hover:bg-purple-600" onclick="viewAdvanceHistory(${order.id})">View</button></td>
                                    <td class="md:table-cell hidden">${statusHtml}</td>
                                    <td class="md:hidden">
                                        <button class="action-button bg-blue-500 text-white hover:bg-blue-600" onclick="showMoreActions(${order.id})">
                                            ...
                                        </button>
                                    </td>
                                `;
                                tableBody.appendChild(row);
                            })
                            .catch(error => {
                                console.error('Error fetching order items for status check:', error);
                            });
                    });
                })
                .catch(error => {
                    console.error('Error fetching orders:', error);
                });
        });

        function viewItems(orderId) {
            fetch(`/fetch-order/${orderId}`)
                .then(response => response.json())
                .then(data => {
                    const itemsTableBody = document.querySelector('#itemsTable tbody');
                    itemsTableBody.innerHTML = '';

                    data.items.forEach(item => {
                        const row = document.createElement('tr');
                        const isDelivered = item.delivery_status === 'delivered';
                        row.innerHTML = `
                            <td class="py-2 px-3">${item.item_type}</td>
                            <td class="py-2 px-3">${item.item_name}</td>
                            <td class="py-2 px-3">${item.quantity}</td>
                            <td class="py-2 px-3 whitespace-nowrap">‚Çπ${formatNumber(item.amount_per_gram)}</td>
                            <td class="py-2 px-3 whitespace-nowrap">‚Çπ${formatNumber(item.making_charges)}</td>
                            <td class="py-2 px-3">${item.wastage}%</td>
                            <td class="py-2 px-3 max-w-xs overflow-hidden text-ellipsis whitespace-nowrap">${item.item_description}</td>
                            <td class="py-2 px-3 whitespace-nowrap">‚Çπ${formatNumber(item.total_amount)}</td>
                            <td class="py-2 px-3">
                                <button 
                                    onclick="updateDeliveryStatus(${orderId}, ${item.id}, this)"
                                    class="status-button ${isDelivered ? 'delivered' : 'pending'} action-button px-2 py-1 text-xs"
                                    ${isDelivered ? 'disabled' : ''}
                                >${item.delivery_status}</button>
                            </td>
                            <td class="py-2 px-3"><button class="action-button bg-blue-400 text-white hover:bg-blue-500 px-2 py-1 text-xs" onclick="viewOrderImage(${orderId}, '${item.sub_id}')">üñºÔ∏è</button></td>
                        `;
                        itemsTableBody.appendChild(row);
                    });

                    document.getElementById('itemsModal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('Error fetching order items:', error);
                });
        }
        
        // --- Remaining Utility Functions (Delivery Status, Payment, History, Images) ---

        function updateDeliveryStatus(orderId, itemId, button) {
            if (button.textContent === 'pending') {
                const modalOverlay = document.createElement('div');
                modalOverlay.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: flex;
                    justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(12px);
                    animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer;
                `;

                const modalContent = document.createElement('div');
                modalContent.style.cssText = `
                    background: linear-gradient(165deg, #ffffff, #f5f7fa); padding: 48px; border-radius: 32px;
                    text-align: center; max-width: 520px; width: 94%; box-shadow: 0 30px 60px -12px rgba(0,0,0,0.3),
                    0 12px 32px -8px rgba(0,0,0,0.2), inset 0 2px 6px rgba(255,255,255,0.9);
                    transform: translateY(0); animation: slideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
                    border: 1px solid rgba(255,255,255,0.22); cursor: default; position: relative; overflow: hidden;
                `;

                modalContent.innerHTML = `
                    <style>
                        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                        @keyframes slideIn { from { transform: translateY(-40px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
                        @keyframes checkmark { 0% { transform: scale(0); opacity: 0; } 50% { transform: scale(1.2); } 100% { transform: scale(1); opacity: 1; } }
                        .modal-btn {
                            padding: 16px 32px; border: none; border-radius: 100px; cursor: pointer; font-weight: 700;
                            font-size: 17px; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); margin: 0 12px;
                            letter-spacing: 0.5px; box-shadow: 0 6px 16px rgba(0,0,0,0.15);
                        }
                        .modal-btn:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 8px 20px rgba(0,0,0,0.2); }
                    </style>
                    <div style="font-size: 82px; margin-bottom: 28px;">üì¶</div>
                    <h3 style="margin: 0 0 24px 0; font-size: 32px; color: #2d3436; font-weight: 800;">Mark as Delivered?</h3>
                    <p style="margin: 0 0 36px 0; color: #2d3436; font-size: 18px; line-height: 1.7;">
                        Are you sure you want to mark this item as delivered?
                    </p>
                    <div style="display: flex; justify-content: center; gap: 16px;">
                        <button id="confirmDelivery" class="modal-btn" style="background: linear-gradient(145deg, #2ecc71, #27ae60); color: white;">
                            Confirm
                        </button>
                        <button id="cancelDelivery" class="modal-btn" style="background: linear-gradient(145deg, #f5f6fa, #e9ecef); color: #2d3436;">
                            Cancel
                        </button>
                    </div>
                `;

                document.body.appendChild(modalOverlay);
                modalOverlay.appendChild(modalContent);

                const closeModal = () => { modalOverlay.remove(); };

                const showSuccessModal = () => {
                    modalContent.innerHTML = `
                        <div style="font-size: 82px; margin-bottom: 28px; animation: checkmark 0.8s cubic-bezier(0.4, 0, 0.2, 1);">‚úÖ</div>
                        <h3 style="margin: 0 0 24px 0; font-size: 32px; color: #2ecc71; font-weight: 800;">Marked as Delivered!</h3>
                        <p style="margin: 0 0 36px 0; color: #2d3436; font-size: 18px; line-height: 1.7; background: linear-gradient(120deg, #e8f5e9, #c8e6c9); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.15); border: 2px solid rgba(46, 204, 113, 0.2); display: flex; align-items: center; justify-content: center; gap: 12px; font-family: 'Quicksand', sans-serif;">
                            <span style="display: inline-block; animation: bounce 1s infinite;">üéâ</span>
                            <span style="background: linear-gradient(45deg, #2ecc71, #27ae60); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 600; font-family: 'Montserrat', sans-serif;">The item has been successfully marked as delivered!</span>
                            <span style="display: inline-block; animation: bounce 1s infinite;">üéâ</span>
                        </p>
                    `;
                    setTimeout(closeModal, 2000);
                };

                modalOverlay.onclick = (e) => { if (e.target === modalOverlay) { closeModal(); } };
                document.getElementById('cancelDelivery').onclick = closeModal;

                document.getElementById('confirmDelivery').onclick = () => {
                    fetch(`/update-delivery-status/${orderId}/${itemId}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ status: 'delivered' })
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                button.textContent = 'delivered';
                                button.disabled = true;
                                button.classList.remove('pending');
                                button.classList.add('delivered');
                                checkAndUpdateOrderStatus(orderId);
                                showSuccessModal();
                            }
                        })
                        .catch(error => {
                            console.error('Error updating delivery status:', error);
                            closeModal();
                        });
                };
            }
        }

        function checkAndUpdateOrderStatus(orderId) {
            fetch(`/fetch-order/${orderId}`)
                .then(response => response.json())
                .then(data => {
                    const allDelivered = data.items.every(item => item.delivery_status === 'delivered');
                    if (allDelivered) {
                        const orderRow = document.querySelector(`tr[data-order-id="${orderId}"]`);
                        if (orderRow) {
                            // Update the main table's delivery status cell for large screens
                            const statusCellIndex = 11; // Index of the Delivery Status column in the full table
                            const statusCell = orderRow.children[statusCellIndex]; 
                            if (statusCell) {
                                statusCell.innerHTML = '<div class="delivery-status delivered">‚úì</div>';
                            }
                            // Update the global order data so 'More' button is accurate
                            const globalOrder = allOrders.find(o => o.id === orderId);
                            if (globalOrder) {
                                globalOrder.items.forEach(item => item.delivery_status = 'delivered');
                            }
                        }
                    }
                });
        }
        
        function viewOrderImage(orderId, subItemId) {
            fetch(`/order-images/${orderId}/${subItemId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const existingModal = document.getElementById("imageModal");
                        if (existingModal) existingModal.remove();

                        const modal = document.createElement("div");
                        modal.id = "imageModal";
                        modal.className = "modal-overlay";
                        modal.style.cssText = `z-index: 2000;`; // Higher z-index for image modal

                        const imageContainer = document.createElement("div");
                        imageContainer.className = "image-container p-4 bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 md:mx-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4";
                        imageContainer.onclick = (e) => e.stopPropagation();

                        if (data.images.length === 0) {
                            Swal.fire({ icon: 'warning', title: 'No Images Found!', text: `No images found for Order ID: ${orderId} and SubItem ID: ${subItemId}`, confirmButtonColor: '#3085d6', confirmButtonText: 'OK' });
                            return;
                        }

                        data.images.forEach(base64Image => {
                            const img = document.createElement("img");
                            img.src = `data:image/jpeg;base64,${base64Image}`;
                            img.className = "bill-image w-full h-auto rounded-lg shadow-md cursor-pointer transition transform hover:scale-[1.02]";
                            img.onclick = (event) => {
                                event.stopPropagation();
                                openSingleImageView(img.src);
                            };
                            imageContainer.appendChild(img);
                        });

                        const closeButton = document.createElement('button');
                        closeButton.textContent = 'Close';
                        closeButton.className = 'col-span-full mt-4 p-2 bg-red-500 text-white rounded-lg hover:bg-red-600';
                        closeButton.onclick = () => modal.remove();
                        imageContainer.appendChild(closeButton);

                        modal.appendChild(imageContainer);
                        document.body.appendChild(modal);

                        modal.onclick = () => modal.remove();
                    } else {
                        Swal.fire({ icon: 'warning', title: 'No Images Found!', text: `No images found for Order ID: ${orderId} and SubItem ID: ${subItemId}`, confirmButtonColor: '#3085d6', confirmButtonText: 'OK' });
                    }
                })
                .catch(error => console.error("Error fetching images:", error));
        }
        
        function openSingleImageView(src) {
            const existingModal = document.getElementById("singleImageModal");
            if (existingModal) existingModal.remove();

            const modal = document.createElement("div");
            modal.id = "singleImageModal";
            modal.className = "modal-overlay";
            modal.style.cssText = `z-index: 3000; backdrop-filter: none;`; 

            const img = document.createElement("img");
            img.src = src;
            img.className = "max-w-[95%] max-h-[95vh] object-contain shadow-2xl rounded-lg";
            img.onclick = (e) => e.stopPropagation();

            modal.appendChild(img);
            document.body.appendChild(modal);
            modal.onclick = () => modal.remove();
        }

        // --- Advance Payment Functions ---
        
        let selectedOrderId = null;
        let currentBalance = 0;

        function makeAdvancePayment(orderId, balance) {
            selectedOrderId = orderId;
            currentBalance = balance;

            const existing = document.getElementById('advanceModal');
            if (existing) existing.remove();

            const modal = document.createElement('div');
            modal.id = 'advanceModal';
            modal.innerHTML = `
                <div id="modalOverlay" style="
                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                    background-color: rgba(0, 0, 0, 0.6); display: flex; align-items: center;
                    justify-content: center; z-index: 9999; font-family: 'Poppins', sans-serif;
                ">
                    <div style="
                        background: #fff; border-radius: 20px; padding: 32px; width: 420px;
                        max-width: 90%; box-shadow: 0 20px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s ease;
                        position: relative;" onclick="event.stopPropagation()">

                        <div style="position: absolute; top: 16px; right: 16px; display: flex; align-items: center; gap: 8px;">
                            <label style="font-size: 13px; color: #555;">Full</label>
                            <label class="switch">
                                <input type="checkbox" id="enableFull" onchange="toggleFullPayment(${balance.toFixed(2)})">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <h2 style="font-size: 22px; color: #2c3e50; margin-bottom: 10px;">üí≥ Advance Payment</h2>
                        <p style="color: #555; font-size: 14px; margin-bottom: 20px;">
                            Current Balance: <strong style="font-size: 16px; color: #000;">‚Çπ<span id="modalBalance">${balance.toFixed(2)}</span></strong>
                        </p>

                        <input type="number" id="advanceAmount" placeholder="Enter amount to pay" style="
                            width: 100%; padding: 14px 16px; font-size: 16px; border: 2px solid #eee; border-radius: 12px;
                            margin-bottom: 20px; transition: all 0.3s ease; font-family: 'Poppins', sans-serif;
                        " onfocus="this.style.borderColor='#00b894'" onblur="this.style.borderColor='#eee'"
                        oninput="disableFullToggleOnManualInput(${balance.toFixed(2)})"/>

                        <div style="display: flex; justify-content: space-between; gap: 10px;">
                            <button onclick="submitAdvance()" style="
                                flex: 1; padding: 12px; background: linear-gradient(135deg, #1abc9c, #16a085);
                                color: #fff; font-weight: 600; font-size: 15px; border: none; border-radius: 10px;
                                cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px;
                                transition: transform 0.2s ease;
                            " onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                                üí∞ Pay Now
                            </button>
                            <button onclick="closeAdvanceModal()" style="
                                flex: 1; padding: 12px; background: #f1f1f1; color: #444; font-weight: 600;
                                font-size: 15px; border: none; border-radius: 10px; cursor: pointer;
                                transition: transform 0.2s ease;
                            " onmouseover="this.style.transform='scale(1.03)'" onmouseout="this.style.transform='scale(1)'">
                                ‚ùå Cancel
                            </button>
                        </div>

                        <div id="advanceError" style="
                            margin-top: 15px; color: #e74c3c; font-size: 14px; display: none; text-align: center;
                        "></div>
                    </div>
                </div>
                <style>@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }</style>
            `;

            document.body.appendChild(modal);
            document.getElementById('modalOverlay').addEventListener('click', closeAdvanceModal);

            document.addEventListener('keydown', function escClose(e) {
                if (e.key === 'Escape') {
                    closeAdvanceModal();
                    document.removeEventListener('keydown', escClose);
                }
            });
        }

        function toggleFullPayment(balance) {
            const toggle = document.getElementById('enableFull');
            const input = document.getElementById('advanceAmount');
            if (toggle.checked) {
                input.value = balance.toFixed(2);
            } else {
                input.value = '';
            }
        }

        function disableFullToggleOnManualInput(balance) {
            const input = document.getElementById('advanceAmount');
            const toggle = document.getElementById('enableFull');

            const entered = parseFloat(input.value);
            if (isNaN(entered) || Math.abs(entered - balance) > 0.001) {
                toggle.checked = false;
            } else if (Math.abs(entered - balance) <= 0.001) {
                toggle.checked = true;
            }
        }
        
        function closeAdvanceModal() {
            const modal = document.getElementById('advanceModal');
            if (modal) modal.remove();
        }
function showSuccessToast(message) {
    // Remove existing toast if present
    const existing = document.getElementById('successToast');
    if (existing) existing.remove();

    // Create toast container
    const toast = document.createElement('div');
    toast.id = 'successToast';
    toast.innerHTML = `
        <div style="
            position: fixed;
            top: 25%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1abc9c, #16a085);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 15px 40px rgba(0,0,0,0.3);
            font-family: 'Poppins', sans-serif;
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: fadeInCenter 0.4s ease, fadeOutCenter 0.4s ease 2.6s;
            z-index: 10000;
        ">
            <span style="font-size: 20px;">üíé</span>
            <span>${message}</span>
        </div>

        <style>
            @keyframes fadeInCenter {
                from { opacity: 0; transform: translate(-50%, -60%); }
                to { opacity: 1; transform: translate(-50%, -50%); }
            }
            @keyframes fadeOutCenter {
                from { opacity: 1; transform: translate(-50%, -50%); }
                to { opacity: 0; transform: translate(-50%, -60%); }
            }
        </style>
    `;
    document.body.appendChild(toast);

    // Auto remove after 3s
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

       async function submitAdvance() {
    const amountInput = document.getElementById('advanceAmount');
    const errorDiv = document.getElementById('advanceError');
    const amount = parseFloat(amountInput.value);

    // Validate input
    if (isNaN(amount) || amount <= 0) {
        errorDiv.textContent = 'Please enter a valid amount';
        errorDiv.style.display = 'block';
        return;
    }

    if (amount > currentBalance) {
        errorDiv.textContent = 'Amount exceeds current balance';
        errorDiv.style.display = 'block';
        return;
    }

    try {
        // Send POST request to backend
        const response = await fetch('/make-advance-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                orderId: selectedOrderId,
                amount: amount
            })
        });

        const data = await response.json();

        if (data.success) {
            // Payment successful
            showSuccessToast('Advance payment successful!');

            // Update modal balance and input
            currentBalance -= amount;
            document.getElementById('modalBalance').textContent = currentBalance.toFixed(2);
            amountInput.value = '';
            errorDiv.style.display = 'none';

            // Optionally, refresh order list or table on page
            // refreshOrders();

            closeAdvanceModal();

             setTimeout(() => {
                            location.reload();
                        }, 2000);
        } else {
            // Backend returned an error
            errorDiv.textContent = data.error || 'Something went wrong';
            errorDiv.style.display = 'block';
        }
    } catch (err) {
        console.error('Error submitting advance payment:', err);
        errorDiv.textContent = 'Failed to process payment. Try again!';
        errorDiv.style.display = 'block';
    }
}      
        function viewAdvanceHistory(orderId) {
            fetch(`/get-advance-history/${orderId}`)
                .then(res => res.json())
                .then(data => {
                    if (!data.length) {
                        alert("No advance payment history found.");
                        return;
                    }

                    const historyRows = data.map(payment => `
                        <tr class="hover:bg-gray-50">
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${payment.sub_id}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">‚Çπ${payment.amount.toFixed(2)}</td>
                            <td style="padding: 8px; border-bottom: 1px solid #eee;">${new Date(payment.date).toLocaleString('en-GB', {
                                day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
                            })}</td>
                        </tr>
                    `).join('');

                    const modal = document.createElement('div');
                    modal.id = 'historyModal';
                    modal.innerHTML = `
                        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999;" 
                            onclick="document.getElementById('historyModal').remove()">
                            <div onclick="event.stopPropagation()" style="
                                background: #fff; padding: 24px; border-radius: 10px; max-width: 500px;
                                width: 100%; font-family: 'Poppins', sans-serif; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                            ">
                                <h3 style="margin-bottom: 16px; font-size: 20px; font-weight: 700; color: #333;">üìÑ Advance Payment History</h3>
                                <div style="max-height: 300px; overflow-y: auto; border: 1px solid #ccc; border-radius: 6px;">
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #f0f0f0;">
                                                <th style="padding: 8px; border-bottom: 1px solid #ccc; text-align: left;">Sub ID</th>
                                                <th style="padding: 8px; border-bottom: 1px solid #ccc; text-align: left;">Amount</th>
                                                <th style="padding: 8px; border-bottom: 1px solid #ccc; text-align: left;">Date</th>
                                            </tr>
                                        </thead>
                                        <tbody>${historyRows}</tbody>
                                    </table>
                                </div>
                                <div style="text-align: right; margin-top: 20px;">
                                    <button onclick="document.getElementById('historyModal').remove()" style="
                                        padding: 10px 16px; background: #e74c3c; color: #fff; border: none; 
                                        border-radius: 6px; font-weight: 600; cursor: pointer; hover:opacity:0.9;
                                    ">Close</button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                })
                .catch(err => {
                    console.error('History fetch error:', err);
                    alert("Something went wrong while fetching payment history.");
                });
        }
    </script>
</body>
</html>