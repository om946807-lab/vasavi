<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sale Slip - Dynamic Jewellers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-dark': '#1f2937', // Dark background for containers
                        'secondary-dark': '#374151', // Slightly lighter dark for headers/table
                        'text-light': '#f3f4f6', // Light text color
                        'accent-blue': '#3b82f6', // Primary action color
                        'accent-green': '#10b981', // Success color
                        'accent-red': '#ef4444', // Danger color
                    }
                }
            }
        }
    </script>
    <style>
        /* General body styling for a clean look */
        body {
            background-color: #030712; /* Deep background */
            color: #d1d5db; /* Default light text */
            font-family: ui-sans-serif, system-ui, sans-serif;
        }
        .container {
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        /* Style for all input/select elements */
        input:not([type="checkbox"]), select {
            border: 1px solid #4b5563;
            background-color: #1f2937;
            color: #f3f4f6;
            padding: 10px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        input:focus, select:focus {
            border-color: #3b82f6;
            ring: 2px;
            ring-color: #3b82f6;
            outline: none;
        }
        /* Custom header */
        header {
            border-bottom: 2px solid #374151;
        }
    </style>
</head>
<body class="p-6">
    
    <header class="mb-8 pb-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-4xl font-extrabold text-accent-blue">Sale Slip</h1>
            <a href="generate-bill.html" class="bg-accent-blue hover:bg-blue-700 text-white px-5 py-2 rounded-lg transition duration-200 shadow-lg">
                Back
            </a>
        </div>
    </header>
    
    <div class="container max-w-7xl mx-auto p-8 bg-primary-dark rounded-xl">
        
        <div id="successMessage" class="hidden fixed top-5 left-1/2 -translate-x-1/2 bg-accent-green text-white font-semibold p-4 rounded-lg shadow-2xl z-50">
            ✅ Bill Generated Successfully!
        </div>

        <h2 class="text-2xl font-semibold mb-4 text-text-light">Customer Details & Bill</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 p-4 bg-secondary-dark rounded-lg">
            <div class="md:col-span-1 flex items-center">
                <span id="billNumber" class="text-xl font-bold text-yellow-400">Bill Number: LOADING...</span>
            </div>
            <div class="space-y-1">
                <label for="customerName" class="text-sm text-gray-400">Customer Name:</label>
                <input type="text" id="customerName" name="customerName" required class="w-full">
            </div>
            <div class="space-y-1">
                <label for="customerPhone" class="text-sm text-gray-400">Customer Phone:</label>
                <input type="text" id="customerPhone" name="customerPhone" required class="w-full">
            </div>
        </div>

        <div class="flex items-center justify-center my-6">
            <span class="text-lg font-medium text-gray-400">Single Item</span>
            <label class="switch mx-4 relative inline-block w-12 h-6">
                <input type="checkbox" id="massEntrySwitch" onchange="toggleForms()" class="opacity-0 w-0 h-0">
                <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 bg-gray-600 transition-all duration-400 rounded-full before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-white before:transition-all before:duration-400 before:rounded-full"></span>
            </label>
            <span class="text-lg font-medium text-gray-400">Mass Items</span>
            <style>
                #massEntrySwitch:checked + .slider { background-color: #3b82f6; }
                #massEntrySwitch:checked + .slider:before { transform: translateX(24px); }
            </style>
        </div>
        
        <div id="singleItemForm" class="p-6 border border-gray-700 rounded-lg bg-secondary-dark">
            <h2 class="text-xl font-semibold mb-5 text-accent-blue">Item Details (Single Item)</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="space-y-1">
                    <label for="itemType" class="text-sm text-gray-400">Item Type:</label>
                    <select id="itemType" name="itemType" class="w-full">
                        <option value="">Select Item Type</option>
                        <option value="gold">Gold</option>
                        <option value="silver">Silver</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label for="itemId" class="text-sm text-gray-400">Item ID:</label>
                    <select id="itemId" name="itemId" class="w-full">
                        <option value="">Select Item ID</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label for="itemName" class="text-sm text-gray-400">Item Name:</label>
                    <input type="text" id="itemName" name="itemName" readonly class="w-full bg-gray-600/50 cursor-not-allowed">
                </div>
                <div class="space-y-1">
                    <label for="quantity" class="text-sm text-gray-400">Total Weight (gm):</label>
                    <input type="number" id="quantity" name="quantity" step="0.01" readonly class="w-full bg-gray-600/50 cursor-not-allowed">
                </div>
                <div class="space-y-1">
                    <label for="stoneWeight" class="text-sm text-gray-400">Stone Weight (gm):</label>
                    <input type="number" id="stoneWeight" name="stoneWeight" step="0.01" value="0" class="w-full">
                </div>
                <div class="space-y-1">
                    <label for="amountPerGram" class="text-sm text-gray-400">Amount per Gram (₹):</label>
                    <input type="number" id="amountPerGram" name="amountPerGram" step="0.01" required class="w-full">
                </div>
                <div class="space-y-1">
                    <label for="makingCharges" class="text-sm text-gray-400">Making Charges (₹):</label>
                    <input type="number" id="makingCharges" name="makingCharges" step="0.01" value="0" class="w-full">
                </div>
                <div class="space-y-1">
                    <label for="wastage" class="text-sm text-gray-400">Wastage (%):</label>
                    <input type="number" id="wastage" name="wastage" step="0.01" value="0" class="w-full">
                </div>
                <div class="space-y-1 lg:col-span-4">
                    <label for="itemDescription" class="text-sm text-gray-400">Item Description (Optional):</label>
                    <input type="text" id="itemDescription" name="itemDescription" class="w-full">
                </div>
                <div class="lg:col-span-4 mt-2">
                    <button type="button" onclick="addItem()" class="w-full bg-accent-blue hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition duration-200">Add Item</button>
                </div>
            </div>
        </div>
        
        <div id="massItemForm" style="display:none;" class="p-6 border border-gray-700 rounded-lg bg-secondary-dark">
            <h2 class="text-xl font-semibold mb-5 text-accent-blue">Item Details (Mass Items)</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="space-y-1">
                    <label for="massItemType" class="text-sm text-gray-400">Item Type:</label>
                    <select id="massItemType" name="itemType" onchange="handleItemTypeChange()" class="w-full">
                        <option value="">Select Item Type</option>
                        <option value="goldOrnaments">Gold Ornaments</option>
                        <option value="silverOrnaments">Silver Ornaments</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label for="massItemName" class="text-sm text-gray-400">Item Name:</label>
                    <select id="massItemName" name="itemName" class="w-full">
                        <option value="">Select Item Name</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label for="massitemId" class="text-sm text-gray-400">Item Id:</label>
                    <input type="number" id="massitemId" name="massitemId" readonly class="w-full bg-gray-600/50 cursor-not-allowed">
                </div>
                <div class="space-y-1">
                    <label for="massQuantity" class="text-sm text-gray-400">Total Weight (gm):</label>
                    <input type="number" id="massQuantity" name="quantity" step="0.01" required class="w-full">
                </div>
                <div class="space-y-1">
                    <label for="massStoneWeight" class="text-sm text-gray-400">Stone Weight (gm):</label>
                    <input type="number" id="massStoneWeight" name="massStoneWeight" step="0.01" value="0" class="w-full">
                </div>
                <div class="space-y-1">
                    <label for="massAmountPerGram" class="text-sm text-gray-400">Amount per Gram (₹):</label>
                    <input type="number" id="massAmountPerGram" name="amountPerGram" step="0.01" required class="w-full">
                </div>
                <div class="space-y-1">
                    <label for="massMakingCharges" class="text-sm text-gray-400">Making Charges (₹):</label>
                    <input type="number" id="massMakingCharges" name="makingCharges" step="0.01" value="0" class="w-full">
                </div>
                <div class="space-y-1">
                    <label for="massWastage" class="text-sm text-gray-400">Wastage (%):</label>
                    <input type="number" id="massWastage" name="wastage" step="0.01" value="0" class="w-full">
                </div>
                <div class="space-y-1 lg:col-span-4">
                    <label for="massItemDescription" class="text-sm text-gray-400">Item Description (Optional):</label>
                    <input type="text" id="massItemDescription" name="itemDescription" class="w-full">
                </div>
                <div class="lg:col-span-4 mt-2">
                    <button type="button" onclick="addMassItem()" class="w-full bg-accent-blue hover:bg-blue-700 text-white font-semibold py-2 rounded-lg transition duration-200">Add Item</button>
                </div>
            </div>
        </div>
        
        <h2 class="text-2xl font-semibold mt-10 mb-4 text-text-light">Bill Summary</h2>
        <div class="overflow-x-auto border border-gray-700 rounded-lg">
            <table id="billSummary" class="min-w-full divide-y divide-gray-700">
                <thead class="bg-secondary-dark">
                    <tr>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-left text-gray-300">Item Type</th>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-left text-gray-300">Item ID</th>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-left text-gray-300">Item Name</th>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-right text-gray-300">Total Wt(gm)</th>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-right text-gray-300">Stone Wt(gm)</th>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-right text-accent-red">Net Wt(gm)</th>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-right text-gray-300">Wastage (%)</th>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-right text-gray-300">Amt/Gram</th>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-right text-gray-300">M. Charges (₹)</th>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-right text-yellow-400">Total Amount (₹)</th>
                        <th class="px-3 py-3 text-xs font-medium uppercase tracking-wider text-center text-gray-300">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-700 bg-primary-dark">
                    </tbody>
            </table>
        </div>

        <div class="mt-8 flex justify-end">
            <div class="space-y-4 p-6 bg-secondary-dark rounded-lg w-full max-w-sm">
                <div class="flex justify-between items-center border-b border-gray-600 pb-2">
                    <label class="font-bold text-lg text-text-light">Gross Total:</label>
                    <span id="totalBillAmount" class="font-extrabold text-xl text-yellow-400">₹0.00</span> 
                </div>

                <div class="flex justify-between items-center">
                    <label for="discount" class="text-sm text-gray-400">Discount (₹):</label>
                    <input type="number" id="discount" name="discount" step="0.01" value="0" class="text-right w-2/5 p-2 bg-primary-dark border-gray-600">
                </div>

                <div class="flex justify-between items-center">
                    <label for="oldGold" class="text-sm text-gray-400">Old Gold Amount (₹):</label>
                    <input type="number" id="oldGold" name="oldGold" step="0.01" value="0" class="text-right w-2/5 p-2 bg-primary-dark border-gray-600">
                </div>
                
                <div class="flex justify-between items-center">
                    <label for="oldBalance" class="text-sm text-gray-400">Previous Balance (₹):</label>
                    <input type="number" id="oldBalance" name="oldBalance" step="0.01" value="0" class="text-right w-2/5 p-2 bg-primary-dark border-gray-600">
                </div>
                
                <div class="flex justify-between items-center border-t border-gray-600 pt-3">
                    <label for="amountPaid" class="font-semibold text-text-light">Amount Paid (₹):</label>
                    <input type="number" id="amountPaid" name="amountPaid" step="0.01" value="0" class="text-right w-2/5 p-2 bg-primary-dark border-gray-600">
                </div>

                <div class="flex justify-between items-center border-t border-gray-600 pt-3">
                    <label class="font-bold text-lg text-text-light">Net Balance Due:</label>
                    <span id="balanceAmount" class="font-extrabold text-2xl text-accent-green">₹0.00</span> 
                </div>
            </div>
        </div>

        <div class="flex justify-end gap-4 mt-6">
            <button type="button" id="updateButton" class="bg-yellow-600 hover:bg-yellow-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 shadow-md">Update Totals</button>
            <button id="printButton" class="bg-accent-green hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 shadow-xl">Generate Bill & Print</button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let totalBillAmount = 0;
            let billNumber;

            // --- Utility: show modal warning ---
            function showWarning(message) {
                const existingModal = document.getElementById("warning-modal");
                if (existingModal) existingModal.remove();

                const overlay = document.createElement("div");
                overlay.id = "warning-modal";
                overlay.className = "fixed top-0 left-0 w-full h-full bg-black bg-opacity-70 flex justify-center items-center z-[10000] animate-fadeIn";
                overlay.style.animation = "fadeIn 0.3s ease-out";

                const modal = document.createElement("div");
                modal.className = "bg-primary-dark p-8 rounded-xl shadow-2xl text-center max-w-sm border-2 border-accent-red animate-popUp";
                modal.style.animation = "popUp 0.3s ease-out";

                const warningIcon = document.createElement("div");
                warningIcon.innerHTML = "⚠️";
                warningIcon.className = "text-5xl mb-4 animate-bounce";
                warningIcon.style.animation = "bounce 1s infinite";
                modal.appendChild(warningIcon);

                const warningText = document.createElement("p");
                warningText.innerText = message;
                warningText.className = "mb-6 text-lg text-text-light";
                modal.appendChild(warningText);

                const okButton = document.createElement("button");
                okButton.innerText = "OK";
                okButton.className = "bg-accent-blue hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg transition duration-200";
                okButton.onclick = () => {
                    document.body.removeChild(overlay);
                };
                modal.appendChild(okButton);
                overlay.appendChild(modal);
                document.body.appendChild(overlay);
                
                // Keyframes defined in style block at the top
                const styleSheet = document.createElement("style");
                styleSheet.type = "text/css";
                styleSheet.innerText = `@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
                                        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
                                        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }`;
                document.head.appendChild(styleSheet);
            }

            // --- 1. Fetch Next Bill Number (Dynamic) ---
            function fetchNextBillNumber() {
                // YOUR ENDPOINT
                fetch('/next-bill-number') 
                    .then(response => response.json())
                    .then(data => {
                        billNumber = data.nextBillNumber || 'N/A';
                        document.getElementById('billNumber').textContent = `Bill Number: ${billNumber}`;
                    })
                    .catch(error => {
                        // console.error('Error fetching bill number:', error);
                        billNumber = 'Error Loading'; 
                        document.getElementById('billNumber').textContent = `Bill Number: ${billNumber}`;
                    });
            }

            // --- 2. Fetch Single Stock Data (Dynamic) ---
            async function fetchStockData(type) {
                const endpoint = type === 'silver' ? '/view-stock-data-silver' : '/view-stock-data';
                try {
                    const response = await fetch(endpoint);
                    if (response.ok) return response.json();
                    console.error(`Failed to fetch ${type} stock data`);
                    return [];
                } catch (error) {
                    console.error('Error fetching stock data:', error);
                    return [];
                }
            }

            // --- 3. Fetch Single Item Details (Dynamic) ---
            async function fetchItemDetails(type, id) {
                const endpoint = type === 'silver' ? '/view-stock-data-silver' : '/view-stock-data';
                try {
                    const response = await fetch(endpoint);
                    if (response.ok) {
                        const items = await response.json();
                        // IMPORTANT: Ensure item.id is compared correctly (it might be a number in the endpoint response)
                        return items.find(item => String(item.id) === String(id)) || null; 
                    }
                    return null;
                } catch (error) {
                    console.error('Error fetching item details:', error);
                    return null;
                }
            }

            // --- 4. Fetch Mass Stock Data (Dynamic) ---
            async function fetchMassStockData(itemType) {
                const endpoint = itemType === 'silverOrnaments' ? '/view-stock-data-silver-mass' : '/view-stock-data-mass';
                try {
                    const response = await fetch(endpoint);
                    if (response.ok) return await response.json();
                    console.error('Failed to fetch mass stock data');
                    return [];
                } catch (error) {
                    console.error('Error fetching mass stock data:', error);
                    return [];
                }
            }
            
            // --- 5. Fetch Mass Item Details (Dynamic) ---
            async function fetchMassItemDetails(itemType, itemName) {
                const endpoint = itemType === 'silverOrnaments' ? '/view-stock-data-silver-mass' : '/view-stock-data-mass';
                try {
                    const response = await fetch(endpoint);
                    if (response.ok) {
                        const items = await response.json();
                        const typeKey = itemType === 'goldOrnaments' ? 'gold_type' : 'silver_type';
                        return items.find(item => item[typeKey] === itemName) || null;
                    }
                    return null;
                } catch (error) {
                    console.error('Error fetching mass item details:', error);
                    return null;
                }
            }
            
            // --- DOM Manipulation Helpers ---
            function updateItemIdOptions(items) {
                const itemIdSelect = document.getElementById('itemId');
                itemIdSelect.innerHTML = '<option value="">Select Item ID</option>';
                items.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = item.id;
                    itemIdSelect.appendChild(option);
                });
            }
            
            function updateMassItemNameOptions(items, itemType) {
                const itemNameSelect = document.getElementById('massItemName');
                itemNameSelect.innerHTML = '<option value="">Select Item Name</option>';
                // Clear the mass ID field when the item name list is updated
                document.getElementById('massitemId').value = ''; 

                const nameKey = itemType === 'goldOrnaments' ? 'gold_type' : 'silver_type';
                // Get unique names to populate the dropdown
                const uniqueNames = [...new Set(items.map(item => item[nameKey]))];

                uniqueNames.forEach(name => {
                    if (name) { // Skip any null/empty names
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        itemNameSelect.appendChild(option);
                    }
                });
            }


            // --- Calculation Logic (Retained) ---
            function updateAmounts() {
                // Ensure all inputs are treated as numbers, defaulting to 0
                const discount = parseFloat(document.getElementById('discount').value) || 0;
                const oldGold = parseFloat(document.getElementById('oldGold').value) || 0;
                const oldBalance = parseFloat(document.getElementById('oldBalance').value) || 0;
                const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
                
                // Net Balance = Gross Total + Previous Balance - Discount - Amount Paid - Old Gold
                const balanceAmount = totalBillAmount + oldBalance - discount - amountPaid - oldGold;

                document.getElementById('totalBillAmount').textContent = `₹${totalBillAmount.toFixed(2)}`;
                document.getElementById('balanceAmount').textContent = `₹${balanceAmount.toFixed(2)}`;
            }

            // --- Event Listeners for Dynamic Data Loading ---
            
            // Single Item - Type Change
            document.getElementById('itemType').addEventListener('change', async () => {
                const itemType = document.getElementById('itemType').value;
                document.getElementById('itemName').value = '';
                document.getElementById('quantity').value = '';
                document.getElementById('amountPerGram').value = '';
                updateItemIdOptions([]); // Clear existing IDs

                if (itemType) {
                    const items = await fetchStockData(itemType);
                    updateItemIdOptions(items);
                }
            });

            // Single Item - ID Change
            document.getElementById('itemId').addEventListener('change', async () => {
                const itemType = document.getElementById('itemType').value;
                const itemId = document.getElementById('itemId').value;
                const typeKey = itemType === 'gold' ? 'gold_type' : 'silver_type';

                if (itemType && itemId) {
                    const item = await fetchItemDetails(itemType, itemId);
                    if (item) {
                        document.getElementById('itemName').value = item[typeKey] || '';
                        document.getElementById('quantity').value = item.quantity || '';
                        document.getElementById('amountPerGram').value = item.amountPerGram || '0';
                    } else {
                        showWarning('Item details not found for the selected ID.');
                        document.getElementById('itemName').value = '';
                        document.getElementById('quantity').value = '';
                    }
                } else {
                    document.getElementById('itemName').value = '';
                    document.getElementById('quantity').value = '';
                }
            });

            // Mass Item - Type Change
            window.handleItemTypeChange = async function() {
                const itemType = document.getElementById('massItemType').value;
                document.getElementById('massItemName').innerHTML = '<option value="">Select Item Name</option>';
                document.getElementById('massitemId').value = '';

                if (itemType) {
                    const items = await fetchMassStockData(itemType);
                    updateMassItemNameOptions(items, itemType);
                }
            };
            
            // Mass Item - Name Change
            document.getElementById('massItemName').addEventListener('change', async () => {
                const itemType = document.getElementById('massItemType').value;
                const itemName = document.getElementById('massItemName').value;

                if (itemType && itemName) {
                    // Fetch all data for the type, then filter by name to find the details
                    const item = await fetchMassItemDetails(itemType, itemName);
                    
                    if (item) {
                        document.getElementById('massitemId').value = item.id || '';
                        document.getElementById('massQuantity').value = item.quantity || '';
                        // document.getElementById('massAmountPerGram').value = item.amountPerGram || '0'; // Can be pre-filled if available
                    } else {
                        showWarning('Mass Item details not found for the selected Name.');
                        document.getElementById('massitemId').value = '';
                        document.getElementById('massQuantity').value = '';
                    }
                }
            });

            // --- Add Single Item ---
            window.addItem = () => {
                const itemType = document.getElementById('itemType').value;
                const itemId = document.getElementById('itemId').value;
                const itemName = document.getElementById('itemName').value;
                const quantity = parseFloat(document.getElementById('quantity').value) || 0;
                const stoneWeight = parseFloat(document.getElementById('stoneWeight').value) || 0;
                const amountPerGram = parseFloat(document.getElementById('amountPerGram').value) || 0;
                const makingCharges = parseFloat(document.getElementById('makingCharges').value) || 0;
                const wastage = parseFloat(document.getElementById('wastage').value) || 0;
                const itemDescription = document.getElementById('itemDescription').value;

                if (!itemType || !itemId || quantity <= 0 || amountPerGram <= 0) {
                    showWarning('Please select an Item Type/ID and enter valid, non-zero values for Total Weight and Amount per Gram.');
                    return;
                }

                const netMetalWeight = quantity - stoneWeight; 
                if (netMetalWeight < 0) {
                    showWarning('Stone Weight cannot exceed Total Weight.');
                    return;
                }
                
                // Adjusted quantity includes wastage on net metal weight
                const adjustedQuantity = netMetalWeight + (netMetalWeight * (wastage / 100));
                const totalAmount = (amountPerGram * adjustedQuantity) + makingCharges;

                const billSummary = document.getElementById('billSummary').getElementsByTagName('tbody')[0];
                const newRow = billSummary.insertRow();
                newRow.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">${itemType}</td>
                    <td class="px-3 py-2 whitespace-nowrap">${itemId}</td>
                    <td class="px-3 py-2 whitespace-nowrap">${itemName}${itemDescription ? `<br><small class="text-xs text-gray-500 italic">- ${itemDescription}</small>` : ''}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right">${quantity.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right">${stoneWeight.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right font-bold text-accent-red">${netMetalWeight.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right">${wastage.toFixed(2)}%</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right" data-value="${amountPerGram.toFixed(2)}">₹${amountPerGram.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right" data-value="${makingCharges.toFixed(2)}">₹${makingCharges.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right font-semibold text-yellow-400" data-total="${totalAmount.toFixed(2)}">₹${totalAmount.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-center"><button type="button" class="deleteButton bg-accent-red hover:bg-red-600 text-white p-1 rounded text-xs transition duration-150">Delete</button></td>
                `;

                totalBillAmount += totalAmount;
                updateAmounts();

                // Clear single item form inputs
                document.getElementById('itemType').value = '';
                updateItemIdOptions([]);
                document.getElementById('itemName').value = '';
                document.getElementById('quantity').value = '';
                document.getElementById('stoneWeight').value = '0';
                document.getElementById('amountPerGram').value = '';
                document.getElementById('makingCharges').value = '0';
                document.getElementById('wastage').value = '0';
                document.getElementById('itemDescription').value = '';
            };

            // --- Add Mass Item ---
            window.addMassItem = () => {
                const itemType = document.getElementById('massItemType').value;
                const itemId = document.getElementById('massitemId').value; // Mass items use the name for stock-check, but bill needs an ID
                const itemName = document.getElementById('massItemName').value;
                const quantity = parseFloat(document.getElementById('massQuantity').value) || 0;
                const stoneWeight = parseFloat(document.getElementById('massStoneWeight').value) || 0;
                const amountPerGram = parseFloat(document.getElementById('massAmountPerGram').value) || 0;
                const makingCharges = parseFloat(document.getElementById('massMakingCharges').value) || 0;
                const wastage = parseFloat(document.getElementById('massWastage').value) || 0;
                const itemDescription = document.getElementById('massItemDescription').value;

                if (!itemType || !itemName || quantity <= 0 || amountPerGram <= 0) {
                    showWarning('Please select an Item Type/Name and enter valid, non-zero values for Total Weight and Amount per Gram.');
                    return;
                }

                const netMetalWeight = quantity - stoneWeight; 
                if (netMetalWeight < 0) {
                    showWarning('Stone Weight cannot exceed Total Weight.');
                    return;
                }

                const adjustedQuantity = netMetalWeight + (netMetalWeight * (wastage / 100));
                const totalAmount = (amountPerGram * adjustedQuantity) + makingCharges;

                const billSummary = document.getElementById('billSummary').getElementsByTagName('tbody')[0];
                const newRow = billSummary.insertRow();
                newRow.innerHTML = `
                     <td class="px-3 py-2 whitespace-nowrap">${itemType}</td>
                    <td class="px-3 py-2 whitespace-nowrap">${itemId || 'MASS-ENTRY'}</td>
                    <td class="px-3 py-2 whitespace-nowrap">${itemName}${itemDescription ? `<br><small class="text-xs text-gray-500 italic">- ${itemDescription}</small>` : ''}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right">${quantity.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right">${stoneWeight.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right font-bold text-accent-red">${netMetalWeight.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right">${wastage.toFixed(2)}%</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right" data-value="${amountPerGram.toFixed(2)}">₹${amountPerGram.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right" data-value="${makingCharges.toFixed(2)}">₹${makingCharges.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right font-semibold text-yellow-400" data-total="${totalAmount.toFixed(2)}">₹${totalAmount.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-center"><button type="button" class="deleteButton bg-accent-red hover:bg-red-600 text-white p-1 rounded text-xs transition duration-150">Delete</button></td>
                `;

                totalBillAmount += totalAmount;
                updateAmounts();

                // Clear mass inputs
                document.getElementById('massItemType').value = '';
                document.getElementById('massItemName').innerHTML = '<option value="">Select Item Name</option>';
                document.getElementById('massitemId').value = '';
                document.getElementById('massQuantity').value = '';
                document.getElementById('massStoneWeight').value = '0';
                document.getElementById('massAmountPerGram').value = '';
                document.getElementById('massMakingCharges').value = '0';
                document.getElementById('massWastage').value = '0';
                document.getElementById('massItemDescription').value = '';
            };


            // --- Delete Item Handler ---
            document.getElementById('billSummary').addEventListener('click', (event) => {
                if (event.target.classList.contains('deleteButton')) {
                    const row = event.target.closest('tr');
                    const totalCell = row.cells[9]; 
                    const totalAmount = parseFloat(totalCell.getAttribute('data-total')) || 0;

                    totalBillAmount -= totalAmount;
                    updateAmounts();

                    row.remove();
                }
            });

            // --- Update and Print Handlers ---
            document.getElementById('updateButton').addEventListener('click', updateAmounts);
            document.getElementById('discount').addEventListener('input', updateAmounts);
            document.getElementById('oldGold').addEventListener('input', updateAmounts);
            document.getElementById('oldBalance').addEventListener('input', updateAmounts);
            document.getElementById('amountPaid').addEventListener('input', updateAmounts);
            
            window.toggleForms = function() {
                const isMassItem = document.getElementById('massEntrySwitch').checked;
                document.getElementById('singleItemForm').style.display = isMassItem ? 'none' : 'block';
                document.getElementById('massItemForm').style.display = isMassItem ? 'block' : 'none';
            };
            
            document.getElementById('printButton').addEventListener('click', async () => {
                const customerName = document.getElementById('customerName').value.trim();
                const customerPhone = document.getElementById('customerPhone').value.trim();
                const billSummary = document.getElementById('billSummary').getElementsByTagName('tbody')[0];
                const itemRows = billSummary.getElementsByTagName('tr').length;
                
                updateAmounts(); // Final update just before submission
                
                const discount = parseFloat(document.getElementById('discount').value) || 0;
                const oldBalance = parseFloat(document.getElementById('oldBalance').value) || 0;
                const oldGold = parseFloat(document.getElementById('oldGold').value) || 0;
                const amountPaid = parseFloat(document.getElementById('amountPaid').value) || 0;
                const balanceAmount = totalBillAmount + oldBalance - discount - amountPaid - oldGold;


                if (!customerName || !customerPhone || itemRows === 0) {
                    showWarning('Please enter customer details and add at least one item to generate the bill.');
                    return;
                }

                // Prepare items data for API
                const items = Array.from(billSummary.rows).map(row => {
                    const itemNameCell = row.cells[2].textContent;
                    const itemDescriptionMatch = itemNameCell.match(/- (.*)/);
                    const itemDescription = itemDescriptionMatch ? itemDescriptionMatch[1].trim() : '';
                    const itemName = itemNameCell.replace(itemDescription ? `- ${itemDescription}` : '', '').trim();

                    return {
                        itemType: row.cells[0].textContent,
                        itemId: row.cells[1].textContent,
                        itemName: itemName,
                        quantity: parseFloat(row.cells[3].textContent),
                        stoneWeight: parseFloat(row.cells[4].textContent),
                        netMetalWeight: parseFloat(row.cells[5].textContent),
                        wastage: parseFloat(row.cells[6].textContent.replace('%', '')),
                        amountPerGram: parseFloat(row.cells[7].textContent.replace('₹', '')),
                        makingCharges: parseFloat(row.cells[8].textContent.replace('₹', '')),
                        totalPrice: parseFloat(row.cells[9].textContent.replace('₹', '')),
                        itemDescription: itemDescription
                    };
                });

                try {
                    // API Call to your backend to generate the bill
                    const response = await fetch('/generate-bill', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            billNumber: billNumber, // Use the dynamically loaded bill number
                            customerName,
                            customerPhone,
                            items,
                            subtotal: totalBillAmount,
                            discount,
                            oldGold,
                            oldBalance,
                            amountPaid,
                            balanceAmount: balanceAmount
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        console.log(result.message);
                        const successMessage = document.getElementById('successMessage');
                        successMessage.classList.remove('hidden');

                        setTimeout(() => {
                            successMessage.classList.add('hidden');
                            // Open print view and refresh form
                            window.location.href = `purchase-print-bill.html?billNumber=${billNumber}`;
                            // location.reload(); 
                        }, 2000);
                        
                    } else {
                        console.error('Failed to generate bill');
                        showWarning('Failed to generate bill. Server error.');
                    }
                } catch (error) {
                    console.error('Error generating bill:', error);
                    showWarning('Error connecting to server. Check console for details.');
                }
            });
            
            fetchNextBillNumber();
            window.toggleForms(); 
        });
    </script>
</body>
</html>